<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perception Experiment</title>
<style>
body {
  font-family: sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}
.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h1 { font-size: 24px; margin-top: 0; }
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 8px;
}
.btn-primary { background: #007acc; color: white; }
.btn-primary:disabled {
  background: #a0aec0;
  color: #e2e8f0;
  cursor: not-allowed;
}
.btn-secondary { background: #ccc; color: black; }
.hidden { display: none; }
.progress {
  height: 8px;
  background: #eee;
  border-radius: 4px;
  margin: 10px 0;
  overflow: hidden;
}
.progress > div {
  height: 100%;
  background: #007acc;
  width: 0;
  transition: width .2s ease;
}
textarea {
  width: 100%;
  height: 100px;
  margin-top: 8px;
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-family: sans-serif;
}
.question-block {
  margin: 20px 0;
  padding: 12px;
  background: #f9f9f9;
  border-radius: 6px;
  border: 1px solid #ddd;
}
.question-block p {
  margin: 0 0 8px 0;
  font-weight: bold;
}
.question-block label {
  display: block;
  margin: 4px 0;
}
/* Slider styling */
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 8px;
  border-radius: 5px;
  background: #ddd;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: #aaa;
  cursor: pointer;
  margin-top: -5px;
  transition: background 0.2s;
}
input[type="range"].active::-webkit-slider-thumb { background: #007bff; }
input[type="range"]::-moz-range-thumb {
  width: 18px; height: 18px; border-radius: 50%; background: #aaa;
  transition: background 0.2s; cursor: pointer;
}
input[type="range"].active::-moz-range-thumb { background: #007bff; }
.scale-labels {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #555;
  margin-top: 6px;
}
.scale-labels span {
  flex: 1;
  text-align: center;
  white-space: nowrap;
}
</style>
</head>
<body>

<!-- Consent -->
<div class="card" id="screen-consent">
  <h1>Intro and Consent</h1>
  <p>Thank you for participating!</p>
  <p>We are testing A.I. generated voices trained on multiple dialects, voices, and genders, so your input about these traits is important for the continued development of voice assistants.</p>
  <p>This experiment will be somewhat repetitive — please pay close attention to each trial.</p>
  <p>Before starting, please read the <a href="#" target="_blank">Informed Consent Form</a>, then check the box below once done.</p>
  <label><input type="checkbox" id="consentCheck"> I consent to participate</label>
  <br><br>
  <button class="btn btn-primary" id="consentBtn" disabled>Continue</button>
</div>

<!-- Audio Attention Check (reused throughout, including right after consent) -->
<div class="card hidden" id="screen-audiocheck">
  <button class="btn btn-primary" id="playAudioCheckBtn">Play Audio</button>
  <audio id="audioCheckPlayer"></audio>
  <div class="question-block">
    <p>Play the audio and type the answer to the question you heard:</p>
    <input type="text" id="audioCheckResponse" style="width:300px; padding:6px;">
  </div>
  <button class="btn btn-primary" id="audioCheckNextBtn" disabled>Continue</button>
</div>

<!-- Trial Block -->
<div class="card hidden" id="screen-block">
  <div class="progress"><div id="progressBar"></div></div>
  <p>Please press the button to listen to the audio, then answer the questions below:</p>
  <button class="btn btn-primary" id="playBtn">Play Audio</button>
  <button class="btn btn-secondary" id="skipBtn">Skip (Pilot Only)</button>
  <audio id="player" preload="auto"></audio>
  <div id="questionsContainer"></div>
  <div style="margin-top:12px;">
    <button class="btn btn-primary" id="nextBtn" disabled>Next</button>
  </div>
</div>

<!-- Demographics -->
<div class="card hidden" id="screen-demographics">
  <h1>Please answer the following questions about yourself</h1>
  <div id="demoQuestions"></div>
  <button class="btn btn-primary" id="demoNextBtn" disabled>Next</button>
</div>

<!-- Feedback -->
<div class="card hidden" id="screen-feedback">
  <h1>Final Feedback</h1>
  <textarea id="feedbackText"></textarea>
  <button class="btn btn-primary" id="feedbackNextBtn">Submit</button>
</div>

<!-- Finish -->
<div class="card hidden" id="screen-finish">
  <h1>All Done!</h1>
  <p>Thank you for participating.</p>
</div>

<script>
/* ===========================
   GOOGLE SHEETS ENDPOINT + SENDER
=========================== */
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyKd3LyCOlJZxnlEmXg3GL4RUmIRti97oVc2vbB08_ut4LJGpNJ0cKUZ5ND2wplfDBW/exec";

async function sendToSheet(data){
  try{
    await fetch(GOOGLE_SHEET_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    console.log("✅ Sent to Google Sheet", data);
  }catch(err){
    console.error("❌ Sheet send error:", err);
  }
}

/* ===========================
   Helpers / Visuals
=========================== */
function setSliderBackground(slider){
  if(!slider.classList.contains('active')){slider.style.background='#ddd';return;}
  const min=Number(slider.min),max=Number(slider.max),val=Number(slider.value);
  const percent=((val-min)/(max-min))*100;
  slider.style.background=`linear-gradient(to right,#007bff 0%,#007bff ${percent}%,#ddd ${percent}%,#ddd 100%)`;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* ===========================
   Config (updated for .mp3 + new paths)
=========================== */
const CONFIG = {
  assetsBase: '../data/soundfiles',   // go up one level from /experiment/
  attnBase: './audio_check',          // inside the current folder
  stimuliPersonality: ['passage'],
  stimuliRace: ['central','fronting','mono','raising'],
  suffix: '.mp3',
  questions:{
    Personality:[
      "How friendly does this speaker sound?",
      "How professional does this speaker sound?",
      "How funny does this speaker sound?",
      "How competent does this speaker sound?",
      "How trustworthy does this speaker sound?",
      "How pleasant does this speaker sound?",
      "How human-like was this voice?"
    ],
    Race:[
      {type:"radio-list",text:"What dialect region does the AI voice sound like?",options:["Midwestern U.S.","Northeastern U.S.","Northwestern U.S.","Southeastern U.S.","Southwestern U.S.","Non-American"]},
      {type:"radio-list",text:"What race does the AI voice sound like?",options:["Asian","Black","Latino/Hispanic","White"]},
      {type:"radio-list",text:"How old does the AI voice sound?",options:["18–24","25–34","35–44","45–54","55+"]},
      {type:"likert",text:"How feminine or masculine does the AI voice sound?",scaleMin:1,scaleMax:7}
    ]
  },
  bins:['BF','BM','WF','WM'],
  numsPerBin:8
};

/* ===========================
   Mapping question text -> sheet keys
=========================== */
const Q2KEY = {
  // Personality (7)
  "How friendly does this speaker sound?":"friendly",
  "How professional does this speaker sound?":"professional",
  "How funny does this speaker sound?":"funny",
  "How competent does this speaker sound?":"competent",
  "How trustworthy does this speaker sound?":"trustworthy",
  "How pleasant does this speaker sound?":"pleasant",
  "How human-like was this voice?":"human_like",
  // Race (4)
  "What dialect region does the AI voice sound like?":"dialect_region",
  "What race does the AI voice sound like?":"perceived_race",
  "How old does the AI voice sound?":"perceived_age",
  "How feminine or masculine does the AI voice sound?":"gender_scale"
};

function filenameForTrial(t){
  return `${t.speaker}_${t.stimulus}${CONFIG.suffix}`; // e.g., BF1_passage.mp3
}

/* ===========================
   Global State
=========================== */
const State={
  blocks:{},
  order:[],
  currentBlock:null,
  trialIndex:0,
  audioFinished:false,
  attnQueue:[],        // shuffled list of 22 attention-check URLs
  attnAnswers:[],      // typed strings in sequence (1..22)
  participantId:null,  // generated at start
  answers:{},          // { friendly: "BF1_passage.mp3 : 5", ... }
  demographics:{}      // { age_range:..., ethnicity:..., ... }
};

/* ===========================
   Consent -> First Audio Attention Check
=========================== */
document.getElementById('consentCheck').onchange=e=>{
  document.getElementById('consentBtn').disabled=!e.target.checked;
};
document.getElementById('consentBtn').onclick=()=>{
  // Generate anonymous participant id at start
  State.participantId = 'P-' + Math.random().toString(36).substring(2,10);

  // Hide consent, show audio attention check #1
  document.getElementById('screen-consent').classList.add('hidden');
  prepareAttentionQueue(); // build & shuffle 22 items
  showAudioAttentionCheck(()=>{ // after first attention check, start experiment
    startExperiment();
  });
};

/* ===========================
   Attention Check Utilities
=========================== */
function prepareAttentionQueue(){
  const urls=[];
  for(let i=1;i<=22;i++){
    urls.push(`${CONFIG.attnBase}/${i}.mp3`);
  }
  State.attnQueue = shuffle(urls);
}
function nextAttentionAudio(){
  if(State.attnQueue.length===0){
    // Safety: rebuild if somehow exhausted
    prepareAttentionQueue();
  }
  return State.attnQueue.shift();
}
function showAudioAttentionCheck(onContinue){
  const card=document.getElementById('screen-audiocheck');
  const playBtn=document.getElementById('playAudioCheckBtn');
  const audio=document.getElementById('audioCheckPlayer');
  const input=document.getElementById('audioCheckResponse');
  const nextBtn=document.getElementById('audioCheckNextBtn');

  // Reset UI
  input.value=""; nextBtn.disabled=true;
  playBtn.disabled=false; playBtn.textContent='Play Audio';

  // Load next randomized attention-check audio
  const attnUrl = nextAttentionAudio();
  audio.src = attnUrl;
  audio.currentTime = 0;

  // Wire events
  playBtn.onclick=async()=>{
    try{ playBtn.disabled=true; playBtn.textContent='Playing...'; await audio.play(); }
    catch{ playBtn.disabled=false; playBtn.textContent='Play Audio';}
  };
  audio.onended=()=>{ playBtn.disabled=false; playBtn.textContent='Replay Audio'; };
  input.oninput=()=>{ nextBtn.disabled = !input.value.trim(); };

  nextBtn.onclick=()=>{
    // Store typed answer in sequence order (1..22)
    const ans = input.value.trim();
    State.attnAnswers.push(ans);
    card.classList.add('hidden');
    onContinue && onContinue();
  };

  // Show card
  card.classList.remove('hidden');
}

/* ===========================
   Stimuli Construction
=========================== */
function buildAllSpeakers(){
  const s=[];
  for(const b of CONFIG.bins){
    for(let n=1;n<=CONFIG.numsPerBin;n++){ s.push(`${b}${n}`); }
  }
  return s;
}
function sampleSpeakersPerBlock(all){
  const byBin=Object.fromEntries(CONFIG.bins.map(b=>[b,[]]));
  for(const sp of all){ byBin[sp.replace(/\d+$/,'')].push(sp); }
  CONFIG.bins.forEach(b=>shuffle(byBin[b]));
  const personality=[],race=[];
  CONFIG.bins.forEach(b=>{ personality.push(...byBin[b].slice(0,4)); race.push(...byBin[b].slice(4,8)); });
  return {personality,race};
}
function buildBlockTrials(speakers,stimuliList,blockName){
  const out=[];
  for(const sp of speakers){
    for(const st of stimuliList){
      const folder=(st==='passage')?'passage':st; // "passage" folder is singular
      out.push({
        block:blockName,
        speaker:sp,
        stimulus:st,
        url:`${CONFIG.assetsBase}/${folder}/${sp}_${st}${CONFIG.suffix}`
      });
    }
  }
  return shuffle(out);
}
function startExperiment(){
  const all=buildAllSpeakers();
  const {personality,race}=sampleSpeakersPerBlock(all);
  State.blocks={
    Personality:buildBlockTrials(personality,CONFIG.stimuliPersonality,'Personality'),
    Race:buildBlockTrials(race,CONFIG.stimuliRace,'Race')
  };
  State.order=['Personality','Race'];
  renderBlock('Personality');
}

/* ===========================
   Block / Trial Rendering
=========================== */
const block=document.getElementById('screen-block');
const progressBar=document.getElementById('progressBar');
const player=document.getElementById('player');
const playBtn=document.getElementById('playBtn');
const nextBtn=document.getElementById('nextBtn');
const questionsContainer=document.getElementById('questionsContainer');

function renderQuestions(blockName){
  questionsContainer.innerHTML='';
  if(blockName==="Personality"){
    shuffle(CONFIG.questions.Personality).forEach(q=>{
      const div=document.createElement('div');
      div.className='question-block';
      div.innerHTML=`<p>${q}</p>
        <input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
        <div class="scale-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>`;
      questionsContainer.appendChild(div);
    });
  } else {
    shuffle(CONFIG.questions.Race).forEach((q,i)=>{
      const div=document.createElement('div');
      div.className='question-block';
      let html=`<p>${q.text}</p>`;
      if(q.type==="radio-list"){
        q.options.forEach(opt=>html+=`<label><input type="radio" name="r${i}" value="${opt}" disabled> ${opt}</label>`);
      } else if(q.type==="likert"){
        html+=`<input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
        <div class="scale-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>`;
      }
      div.innerHTML=html;
      questionsContainer.appendChild(div);
    });
  }
  document.querySelectorAll('.slider').forEach(sl=>{
    setSliderBackground(sl);
    sl.oninput=()=>{sl.dataset.touched="true";sl.classList.add('active');setSliderBackground(sl);updateNextButtonState();};
  });
  document.querySelectorAll('input[type=radio]').forEach(inp=>inp.onchange=updateNextButtonState);
}
function disableInputs(disabled){document.querySelectorAll('#questionsContainer input').forEach(inp=>inp.disabled=disabled);}
function allAnswered(){
  if(State.currentBlock==="Personality") return Array.from(document.querySelectorAll('.slider')).every(sl=>sl.dataset.touched==="true");
  if(State.currentBlock==="Race"){
    const sliders=Array.from(document.querySelectorAll('.slider'));
    const radios=Array.from(document.querySelectorAll('input[type=radio]'));
    const sliderOK=sliders.length===0||sliders.every(sl=>sl.dataset.touched==="true");
    const radioOK=radios.length===0||Array.from(document.querySelectorAll('.question-block')).every(b=>b.querySelector('input:checked'));
    return sliderOK&&radioOK;
  }
  return false;
}
function updateNextButtonState(){ nextBtn.disabled=!(State.audioFinished&&allAnswered()); }
function resetAnswers(){
  document.querySelectorAll('.slider').forEach(sl=>{sl.value=4;sl.dataset.touched="false";sl.disabled=true;setSliderBackground(sl);});
  document.querySelectorAll('input[type=radio]').forEach(r=>{r.checked=false;r.disabled=true;});
  nextBtn.disabled=true;
}
function currentTrials(){ return State.blocks[State.currentBlock]; }
function currentTrial(){ return currentTrials()[State.trialIndex]; }

/* ===========================
   Capture answers for current trial (first-write wins)
=========================== */
function recordCurrentTrialAnswers(){
  const t = currentTrial();
  if(!t) return;
  const fileLabel = `${filenameForTrial(t)}`; // e.g., BF1_passage.mp3

  // Iterate through question blocks currently rendered
  const blocks = Array.from(document.querySelectorAll('#questionsContainer .question-block'));
  for(const b of blocks){
    const prompt = b.querySelector('p')?.textContent?.trim() || "";
    const key = Q2KEY[prompt];
    if(!key) continue;

    // Determine value based on control type
    let val = "";
    const slider = b.querySelector('input[type="range"]');
    const radios = b.querySelectorAll('input[type="radio"]');

    if(slider){
      val = slider.value; // 1..7
    } else if(radios && radios.length){
      const checked = b.querySelector('input[type="radio"]:checked');
      if(!checked) continue;
      val = checked.value;
    }

    // Build "<file> : <value>"
    const cell = `${fileLabel} : ${val}`;

    // First-write wins: only set if not already recorded
    if(!(key in State.answers) || State.answers[key] === ""){
      State.answers[key] = cell;
    }
  }
}

function updateTrialUI(){
  const t=currentTrial(), total=currentTrials().length;
  progressBar.style.width=`${(State.trialIndex/total)*100}%`;
  renderQuestions(State.currentBlock);
  player.src=t.url;
  player.currentTime=0;
  State.audioFinished=false;
  resetAnswers();

  playBtn.disabled=false;
  playBtn.textContent='Play Audio';
  playBtn.onclick=async()=>{
    try{ playBtn.disabled=true; playBtn.textContent='Playing...'; await player.play(); }
    catch{ playBtn.disabled=false; playBtn.textContent='Play Audio'; }
  };
  player.onended=()=>{
    State.audioFinished=true;
    disableInputs(false);
    playBtn.disabled=false;
    playBtn.textContent='Replay Audio';
    updateNextButtonState();
  };
}
function renderBlock(name){
  State.currentBlock=name;
  State.trialIndex=0;
  block.classList.remove('hidden');
  updateTrialUI();
  nextBtn.onclick=handleNext;
  document.getElementById('skipBtn').onclick=()=>{ 
    State.audioFinished=true; 
    // If skipping during pilot, we won't record answers from this trial
    handleNext(); 
  };
}

/* ===========================
   Attention Check Insertion Rules
   - 1 after consent (already handled)
   - Personality: after every 4 trials (4 total for 16 trials)
   - Between Personality and Race: 1
   - Race: after every 4 trials (16 total for 64 trials)
=========================== */
function handleNext(){
  // Before advancing, capture answers for the CURRENT trial
  if(State.audioFinished && allAnswered()){
    recordCurrentTrialAnswers();
  }

  // Move past the just-completed trial
  State.trialIndex++;
  const total=currentTrials().length;
  const atEnd = State.trialIndex >= total;
  const mod4 = (State.trialIndex % 4 === 0);

  // Build list of attention checks we owe *right now* (may be multiple at a boundary)
  const pendingChecks=[];
  if(State.currentBlock==='Personality' && mod4){ pendingChecks.push('post-trial'); }
  if(atEnd && State.currentBlock==='Personality'){ pendingChecks.push('between-blocks'); }
  if(State.currentBlock==='Race' && mod4){ pendingChecks.push('post-trial'); }

  const proceedAfterChecks=()=>{
    if(State.trialIndex < total){
      // Continue within current block
      updateTrialUI();
    } else {
      // Finished current block
      const idx=State.order.indexOf(State.currentBlock);
      if(idx===0){
        // Move to Race block
        renderBlock('Race');
      } else {
        // All done with blocks -> Demographics
        block.classList.add('hidden');
        renderDemographics();
      }
    }
  };

  if(pendingChecks.length>0){
    // Show all pending checks sequentially, then proceed
    const runSeq=(i)=>{
      if(i>=pendingChecks.length){
        // when all attention checks done, show block again
        block.classList.remove('hidden');
        proceedAfterChecks();
        return;
      }
      showAudioAttentionCheck(()=>runSeq(i+1));
    };
    block.classList.add('hidden');
    runSeq(0);

  } else {
    // No check owed now; proceed
    if(State.trialIndex < total){ updateTrialUI(); }
    else {
      const idx=State.order.indexOf(State.currentBlock);
      if(idx===0){ renderBlock('Race'); }
      else { block.classList.add('hidden'); renderDemographics(); }
    }
  }
}

/* ===========================
   Demographics / Feedback
=========================== */
function renderDemographics(){
  const demo=document.getElementById('screen-demographics');
  demo.classList.remove('hidden');
  let html="";
  html+=`<div class="question-block"><p>Please select your age range.</p>`;
  ["18–24","25–34","35–44","45–54","55+"].forEach(opt=>{html+=`<label><input type="radio" name="age" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>Which race/ethnicities do you most strongly identify with? (Check all that apply)</p>`;
  ["Asian American","Black American","Hispanic/Latino American","White American","Native American or other Indigenous culture","Other"].forEach(opt=>{html+=`<label><input type="checkbox" name="ethnicity" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>What regional dialect do you believe is closest to the way you speak?</p>`;
  ["Midwestern U.S.","Northeastern U.S.","Northwestern U.S.","Southeastern U.S.","Southwestern U.S."].forEach(opt=>{html+=`<label><input type="radio" name="dialect" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>What is/are your first language(s)?</p>`;
  ["English","English and another language"].forEach(opt=>{
    html+=`<label><input type="radio" name="firstlang" value="${opt}"> ${opt}</label>`;
  });
  html+=`<div id="otherLangBox" class="hidden"><p>Please enter the language(s) besides English that you grew up speaking:</p><textarea id="otherLangText"></textarea></div></div>`;
  html+=`<div class="question-block"><p>What is your gender?</p>`;
  ["Male","Female","Non-binary"].forEach(opt=>{html+=`<label><input type="radio" name="gender" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>Do you have any speech or hearing disorders?</p>`;
  ["No","Yes"].forEach(opt=>{html+=`<label><input type="radio" name="speech" value="${opt}"> ${opt}</label>`;});
  html+=`<div id="speechDescBox" class="hidden"><p>Please briefly describe the speech or hearing disorder:</p><textarea id="speechDescText"></textarea></div></div>`;
  html+=`<div class="question-block"><p>Have you been diagnosed as neurodivergent by a medical professional?</p>`;
  ["No","Yes"].forEach(opt=>{html+=`<label><input type="radio" name="neuro" value="${opt}"> ${opt}</label>`;});
  html+=`<div id="neuroDescBox" class="hidden"><p>Please briefly state what kind of neurodivergence you have been diagnosed with:</p><textarea id="neuroDescText"></textarea></div></div>`;
  html+=`<div class="question-block"><p>Which technologies do you use regularly?</p>`;
  ["ChatGPT Voice Assistant","Google Gemini Voice","Amazon Alexa","Apple Siri","Microsoft Cortana","Voice-based navigation apps","Other text-to-speech software","None of the above"].forEach(opt=>{html+=`<label><input type="checkbox" name="tech" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>How often do you use AI-based software or AI voice assistants?</p>`;
  ["Never","Less than once per week","A few times per week","About once per day","Several times per day"].forEach(opt=>{html+=`<label><input type="radio" name="aiuse" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;
  html+=`<div class="question-block"><p>What is your attitude towards AI-based software or AI voice assistants?</p>`;
  for(let v=1;v<=7;v++){let label="";if(v===1)label="Very negative";if(v===4)label="Neutral";if(v===7)label="Very positive";html+=`<label><input type="radio" name="aiatt" value="${v}"> ${v} ${label}</label>`;}
  html+=`</div>`;
  document.getElementById('demoQuestions').innerHTML=html;

  const btn=document.getElementById('demoNextBtn');

  // Conditional visibility for text boxes
  function toggleConditional(name,val,box){
    document.querySelectorAll(`input[name="${name}"]`).forEach(inp=>
      inp.addEventListener('change',()=>{
        const b=document.getElementById(box);
        if(inp.checked && inp.value===val){
          b.classList.remove('hidden');
        } else if(inp.checked){
          b.classList.add('hidden');
          b.querySelector('textarea').value="";
        }
        updateBtn();
      })
    );
  }

  toggleConditional('firstlang','English and another language','otherLangBox');
  toggleConditional('speech','Yes','speechDescBox');
  toggleConditional('neuro','Yes','neuroDescBox');

  // Validation logic
  function allDemoAnswered(){
    const age=document.querySelector('input[name="age"]:checked');
    const eth=document.querySelectorAll('input[name="ethnicity"]:checked').length>0;
    const dialect=document.querySelector('input[name="dialect"]:checked');
    const gender=document.querySelector('input[name="gender"]:checked');
    const first=document.querySelector('input[name="firstlang"]:checked');
    const speech=document.querySelector('input[name="speech"]:checked');
    const neuro=document.querySelector('input[name="neuro"]:checked');
    const tech=document.querySelectorAll('input[name="tech"]:checked').length>0;
    const aiuse=document.querySelector('input[name="aiuse"]:checked');
    const aiatt=document.querySelector('input[name="aiatt"]:checked');

    if(!age||!eth||!dialect||!gender||!first||!speech||!neuro||!tech||!aiuse||!aiatt) return false;

    // Require text input when any conditional box is visible
    if(first.value==="English and another language" && !document.getElementById('otherLangText').value.trim()) return false;
    if(speech.value==="Yes" && !document.getElementById('speechDescText').value.trim()) return false;
    if(neuro.value==="Yes" && !document.getElementById('neuroDescText').value.trim()) return false;

    return true;
  }

  function updateBtn(){ btn.disabled=!allDemoAnswered(); }

  document.querySelectorAll('#demoQuestions input,#demoQuestions textarea').forEach(el=>{
    el.addEventListener('input',updateBtn);
    el.addEventListener('change',updateBtn);
  });

  btn.disabled = true;

  btn.onclick=()=>{
    if(allDemoAnswered()){
      // Collect demographics into State.demographics (using sheet column names)
      const age = document.querySelector('input[name="age"]:checked')?.value || "";
      const eth = Array.from(document.querySelectorAll('input[name="ethnicity"]:checked')).map(e=>e.value).join(", ");
      const dialect = document.querySelector('input[name="dialect"]:checked')?.value || "";
      const first = document.querySelector('input[name="firstlang"]:checked')?.value || "";
      const otherLangs = document.getElementById('otherLangText')?.value?.trim() || "";
      const first_language = (first==="English and another language" && otherLangs) ? `English + ${otherLangs}` : first;
      const gender = document.querySelector('input[name="gender"]:checked')?.value || "";
      const ai_use = document.querySelector('input[name="aiuse"]:checked')?.value || "";
      const ai_attitude = document.querySelector('input[name="aiatt"]:checked')?.value || "";

      State.demographics = {
        age_range: age,
        ethnicity: eth,
        dialect,
        first_language,
        gender,
        ai_use,
        ai_attitude
      };

      demo.classList.add('hidden');
      document.getElementById('screen-feedback').classList.remove('hidden');
    } else {
      alert("Please complete all required questions before continuing.");
    }
  };
}

/* ===========================
   Final submit -> Build payload and send to Sheets
=========================== */
document.getElementById('feedbackNextBtn').onclick=()=>{
  const payload = {
    timestamp: new Date().toISOString(),
    participant_id: State.participantId || ('P-' + Math.random().toString(36).substring(2,10)),

    // Personality (first observed values only)
    friendly: State.answers.friendly || "",
    professional: State.answers.professional || "",
    funny: State.answers.funny || "",
    competent: State.answers.competent || "",
    trustworthy: State.answers.trustworthy || "",
    pleasant: State.answers.pleasant || "",
    human_like: State.answers.human_like || "",

    // Race perception (first observed values only)
    dialect_region: State.answers.dialect_region || "",
    perceived_race: State.answers.perceived_race || "",
    perceived_age: State.answers.perceived_age || "",
    gender_scale: State.answers.gender_scale || "",

    // Attention checks (22 total)
    // Fill sequentially; blanks if fewer than 22
    attention_check_1:  State.attnAnswers[0]  || "",
    attention_check_2:  State.attnAnswers[1]  || "",
    attention_check_3:  State.attnAnswers[2]  || "",
    attention_check_4:  State.attnAnswers[3]  || "",
    attention_check_5:  State.attnAnswers[4]  || "",
    attention_check_6:  State.attnAnswers[5]  || "",
    attention_check_7:  State.attnAnswers[6]  || "",
    attention_check_8:  State.attnAnswers[7]  || "",
    attention_check_9:  State.attnAnswers[8]  || "",
    attention_check_10: State.attnAnswers[9]  || "",
    attention_check_11: State.attnAnswers[10] || "",
    attention_check_12: State.attnAnswers[11] || "",
    attention_check_13: State.attnAnswers[12] || "",
    attention_check_14: State.attnAnswers[13] || "",
    attention_check_15: State.attnAnswers[14] || "",
    attention_check_16: State.attnAnswers[15] || "",
    attention_check_17: State.attnAnswers[16] || "",
    attention_check_18: State.attnAnswers[17] || "",
    attention_check_19: State.attnAnswers[18] || "",
    attention_check_20: State.attnAnswers[19] || "",
    attention_check_21: State.attnAnswers[20] || "",
    attention_check_22: State.attnAnswers[21] || "",

    // Demographics
    age_range:     State.demographics.age_range     || "",
    ethnicity:     State.demographics.ethnicity     || "",
    dialect:       State.demographics.dialect       || "",
    first_language:State.demographics.first_language|| "",
    gender:        State.demographics.gender        || "",
    ai_use:        State.demographics.ai_use        || "",
    ai_attitude:   State.demographics.ai_attitude   || "",

    // Feedback
    feedback_text: document.getElementById('feedbackText').value || ""
  };

  // Send once at the very end
  sendToSheet(payload);

  // Finish UI
  document.getElementById('screen-feedback').classList.add('hidden');
  document.getElementById('screen-finish').classList.remove('hidden');
};
</script>
</body>
</html>
