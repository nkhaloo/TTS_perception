<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perception Experiment</title>
<style>
body {
  font-family: sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}
.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h1 {
  font-size: 24px;
  margin-top: 0;
}
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 8px;
}
.btn-primary {
  background: #007acc;
  color: white;
}
.btn-primary:disabled {
  background: #a0aec0;
  color: #e2e8f0;
  cursor: not-allowed;
}
.btn-secondary {
  background: #ccc;
  color: black;
}
.hidden { display: none; }
.progress {
  height: 8px;
  background: #eee;
  border-radius: 4px;
  margin: 10px 0;
  overflow: hidden;
}
.progress > div {
  height: 100%;
  background: #007acc;
  width: 0;
  transition: width .2s ease;
}
textarea {
  width: 100%;
  height: 100px;
  margin-top: 8px;
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-family: sans-serif;
}
.question-block {
  margin: 20px 0;
  padding: 12px;
  background: #f9f9f9;
  border-radius: 6px;
  border: 1px solid #ddd;
}
.question-block p {
  margin: 0 0 8px 0;
  font-weight: bold;
}
.question-block label {
  display: block;
  margin: 4px 0;
}
/* Slider styling */
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 8px;
  border-radius: 5px;
  background: #ddd;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #aaa;
  cursor: pointer;
  margin-top: -5px;
  transition: background 0.2s;
}
input[type="range"].active::-webkit-slider-thumb { background: #007bff; }
input[type="range"]::-moz-range-thumb {
  width: 18px; height: 18px; border-radius: 50%; background: #aaa;
  transition: background 0.2s; cursor: pointer;
}
input[type="range"].active::-moz-range-thumb { background: #007bff; }
.scale-labels {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #555;
  margin-top: 6px;
}
.scale-labels span {
  flex: 1;
  text-align: center;
  white-space: nowrap;
}
</style>
</head>
<body>

<!-- Consent -->
<div class="card" id="screen-consent">
  <h1>Intro and Consent</h1>
  <p>Thank you so much for participating in our study!</p>
  <p>We are testing A.I. generated voices trained on multiple dialects, voices, and genders, so your input about these traits is important for the continued development of voice assistants.</p>
  <p>Please be as honest as possible in your feedback of these voices.</p>
  <p>Before starting, please read the <a href="#" target="_blank">Informed Consent Form</a>, and then check the box below once you are done reading.</p>
  <label><input type="checkbox" id="consentCheck"> I consent to participate</label>
  <br><br>
  <button class="btn btn-primary" id="consentBtn" disabled>Continue</button>
</div>

<!-- Audio Check -->
<div class="card hidden" id="screen-audiocheck">
  <h1>Audio Check</h1>
  <button class="btn btn-primary" id="playAudioCheckBtn">Play Audio</button>
  <audio id="audioCheckPlayer" src="https://nkhaloo.github.io/AAE_AI/experiment/audio_check/check.mp3"></audio>
  <div class="question-block">
    <p>Type the word you heard:</p>
    <input type="text" id="audioCheckResponse" style="width:300px; padding:6px;">
  </div>
  <button class="btn btn-primary" id="audioCheckNextBtn" disabled>Continue</button>
</div>

<!-- Trial Block -->
<div class="card hidden" id="screen-block">
  <div class="progress"><div id="progressBar"></div></div>
  <p>Please press the button to listen to the audio, then answer the questions below:</p>
  <button class="btn btn-primary" id="playBtn">Play Audio</button>
  <button class="btn btn-secondary" id="skipBtn">Skip (Pilot Only)</button>
  <audio id="player" preload="auto"></audio>
  <div id="questionsContainer"></div>
  <div style="margin-top:12px;">
    <button class="btn btn-primary" id="nextBtn" disabled>Next</button>
  </div>
</div>

<!-- Attention Check -->
<div class="card hidden" id="screen-attncheck">
  <h1>Attention Check</h1>
  <p id="attnQuestion"></p>
  <input type="text" id="attnResponse" style="width:240px; padding:6px;">
  <br><br>
  <button class="btn btn-primary" id="attnNextBtn" disabled>Continue</button>
</div>

<!-- Feedback -->
<div class="card hidden" id="screen-feedback">
  <h1>Final Feedback</h1>
  <textarea id="feedbackText"></textarea>
  <button class="btn btn-primary" id="feedbackNextBtn">Submit</button>
</div>

<!-- Finish -->
<div class="card hidden" id="screen-finish">
  <h1>All Done!</h1>
  <p>Thank you for participating.</p>
</div>

<script>
function setSliderBackground(slider){
  if(!slider.classList.contains('active')){slider.style.background='#ddd';return;}
  const min=Number(slider.min),max=Number(slider.max),val=Number(slider.value);
  const percent=((val-min)/(max-min))*100;
  slider.style.background=`linear-gradient(to right,#007bff 0%,#007bff ${percent}%,#ddd ${percent}%,#ddd 100%)`;
}

const CONFIG={
  assetsBase:'https://nkhaloo.github.io/AAE_AI/data/soundfiles',
  stimuliPersonality:['passage'],
  stimuliRace:['central','fronting','mono','raising'],
  suffix:'.wav',
  questions:{
    Personality:[
      "How friendly does this speaker sound?",
      "How professional does this speaker sound?",
      "How funny does this speaker sound?",
      "How competent does this speaker sound?",
      "How trustworthy does this speaker sound?",
      "How pleasant does this speaker sound?",
      "How human-like was this voice?"
    ],
    Race:[
      {type:"radio-list",text:"What dialect region does the AI voice sound like?",options:["Midwestern U.S.","Northeastern U.S.","Northwestern U.S.","Southeastern U.S.","Southwestern U.S.","Non-American"]},
      {type:"radio-list",text:"What race does the AI voice sound like?",options:["Asian","Black","Latino/Hispanic","White"]},
      {type:"radio-list",text:"How old does the AI voice sound?",options:["18–24","25–34","35–44","45–54","55+"]},
      {type:"likert",text:"How feminine or masculine does the AI voice sound?",scaleMin:1,scaleMax:7}
    ]
  },
  attnChecks:{Personality:{8:"What is the color of the sky on a clear day?",16:"How many 2’s are there in this sequence: 21332262?"}},
  bins:['BF','BM','WF','WM'],
  numsPerBin:8
};

const State={blocks:{},order:[],currentBlock:null,trialIndex:0,audioFinished:false};

document.getElementById('consentCheck').onchange=e=>{
  document.getElementById('consentBtn').disabled=!e.target.checked;
};
document.getElementById('consentBtn').onclick=()=>{
  document.getElementById('screen-consent').classList.add('hidden');
  document.getElementById('screen-audiocheck').classList.remove('hidden');
};

document.getElementById('playAudioCheckBtn').onclick=()=>document.getElementById('audioCheckPlayer').play();
document.getElementById('audioCheckResponse').oninput=e=>{
  document.getElementById('audioCheckNextBtn').disabled=!e.target.value.trim();
};
document.getElementById('audioCheckNextBtn').onclick=()=>{
  document.getElementById('screen-audiocheck').classList.add('hidden');
  startExperiment();
};

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function buildAllSpeakers(){const s=[];for(const b of CONFIG.bins){for(let n=1;n<=CONFIG.numsPerBin;n++){s.push(`${b}${n}`);}}return s;}
function sampleSpeakersPerBlock(all){
  const byBin=Object.fromEntries(CONFIG.bins.map(b=>[b,[]]));
  for(const sp of all){byBin[sp.replace(/\d+$/,'')].push(sp);}
  CONFIG.bins.forEach(b=>shuffle(byBin[b]));
  const personality=[],race=[];
  CONFIG.bins.forEach(b=>{personality.push(...byBin[b].slice(0,4));race.push(...byBin[b].slice(4,8));});
  return {personality,race};
}
function buildBlockTrials(speakers,stimuliList,blockName){
  const out=[];for(const sp of speakers){for(const st of stimuliList){
    const folder=(st==='passage')?'passages':st;
    out.push({block:blockName,speaker:sp,stimulus:st,url:`${CONFIG.assetsBase}/${folder}/${sp}_${st}${CONFIG.suffix}`});
  }}return shuffle(out);
}
function startExperiment(){
  const all=buildAllSpeakers();
  const {personality,race}=sampleSpeakersPerBlock(all);
  State.blocks={
    Personality:buildBlockTrials(personality,CONFIG.stimuliPersonality,'Personality'),
    Race:buildBlockTrials(race,CONFIG.stimuliRace,'Race')
  };
  State.order=['Personality','Race'];
  renderBlock('Personality');
}

const block=document.getElementById('screen-block');
const progressBar=document.getElementById('progressBar');
const player=document.getElementById('player');
const playBtn=document.getElementById('playBtn');
const nextBtn=document.getElementById('nextBtn');
const questionsContainer=document.getElementById('questionsContainer');

function renderQuestions(blockName){
  questionsContainer.innerHTML='';
  if(blockName==="Personality"){
    shuffle(CONFIG.questions.Personality).forEach(q=>{
      const div=document.createElement('div');
      div.className='question-block';
      div.innerHTML=`<p>${q}</p><input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
      <div class="scale-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>`;
      questionsContainer.appendChild(div);
    });
  } else {
    shuffle(CONFIG.questions.Race).forEach((q,i)=>{
      const div=document.createElement('div');
      div.className='question-block';
      let html=`<p>${q.text}</p>`;
      if(q.type==="radio-list"){
        q.options.forEach(opt=>html+=`<label><input type="radio" name="r${i}" value="${opt}" disabled> ${opt}</label>`);
      } else if(q.type==="likert" && q.text.includes("feminine or masculine")){
        html+=`<input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
        <div class="scale-labels">
          <span><div>1</div><div style="font-size:11px">Most Feminine</div></span>
          <span>2</span><span>3</span><span>4</span><span>5</span><span>6</span>
          <span><div>7</div><div style="font-size:11px">Most Masculine</div></span>
        </div>`;
      }
      div.innerHTML=html;
      questionsContainer.appendChild(div);
    });
  }
  document.querySelectorAll('.slider').forEach(sl=>{
    setSliderBackground(sl);
    sl.oninput=()=>{sl.dataset.touched="true";sl.classList.add('active');setSliderBackground(sl);updateNextButtonState();};
  });
  document.querySelectorAll('input[type=radio]').forEach(inp=>inp.onchange=updateNextButtonState);
}

function disableInputs(disabled){document.querySelectorAll('#questionsContainer input').forEach(inp=>inp.disabled=disabled);}
function allAnswered(){
  if(State.currentBlock==="Personality")return Array.from(document.querySelectorAll('.slider')).every(sl=>sl.dataset.touched==="true");
  if(State.currentBlock==="Race"){
    const sliders=Array.from(document.querySelectorAll('.slider'));
    const radios=Array.from(document.querySelectorAll('input[type=radio]'));
    const sliderOK=sliders.length===0||sliders.every(sl=>sl.dataset.touched==="true");
    const radioOK=radios.length===0||Array.from(document.querySelectorAll('.question-block')).every(b=>b.querySelector('input:checked'));
    return sliderOK&&radioOK;
  }
  return false;
}
function updateNextButtonState(){nextBtn.disabled=!(State.audioFinished&&allAnswered());}
function resetAnswers(){document.querySelectorAll('.slider').forEach(sl=>{sl.value=4;sl.dataset.touched="false";sl.disabled=true;setSliderBackground(sl);});document.querySelectorAll('input[type=radio]').forEach(r=>{r.checked=false;r.disabled=true;});nextBtn.disabled=true;}
function currentTrials(){return State.blocks[State.currentBlock];}
function currentTrial(){return currentTrials()[State.trialIndex];}

function updateTrialUI(){
  const t=currentTrial(),total=currentTrials().length;
  progressBar.style.width=`${(State.trialIndex/total)*100}%`;
  renderQuestions(State.currentBlock);
  player.src=t.url;player.currentTime=0;State.audioFinished=false;resetAnswers();
  playBtn.disabled=false;playBtn.textContent='Play Audio';
  playBtn.onclick=async()=>{try{playBtn.disabled=true;playBtn.textContent='Playing...';await player.play();}catch{playBtn.disabled=false;playBtn.textContent='Play Audio';}};
  player.onended=()=>{State.audioFinished=true;disableInputs(false);playBtn.disabled=false;playBtn.textContent='Replay Audio';updateNextButtonState();};
}

function renderBlock(name){
  State.currentBlock=name;State.trialIndex=0;
  block.classList.remove('hidden');updateTrialUI();
  nextBtn.onclick=handleNext;
  document.getElementById('skipBtn').onclick=()=>{State.audioFinished=true;handleNext();};
}

function handleNext(){
  const checks=CONFIG.attnChecks[State.currentBlock];
  State.trialIndex++;
  if(State.currentBlock==="Personality"&&checks&&checks[State.trialIndex]){
    block.classList.add('hidden');
    const attn=document.getElementById('screen-attncheck');
    attn.classList.remove('hidden');
    document.getElementById('attnQuestion').textContent=checks[State.trialIndex];
    const attnResponse=document.getElementById('attnResponse');
    const attnNextBtn=document.getElementById('attnNextBtn');
    attnResponse.value="";attnNextBtn.disabled=true;
    attnResponse.oninput=()=>attnNextBtn.disabled=!attnResponse.value.trim();
    attnNextBtn.onclick=()=>{
      attn.classList.add('hidden');
      if(State.trialIndex===16){renderBlock('Race');}
      else{block.classList.remove('hidden');updateTrialUI();}
    };
    return;
  }
  if(State.trialIndex<currentTrials().length){updateTrialUI();}
  else{
    const idx=State.order.indexOf(State.currentBlock);
    if(idx===0){renderBlock('Race');}
    else{block.classList.add('hidden');document.getElementById('screen-feedback').classList.remove('hidden');}
  }
}

document.getElementById('feedbackNextBtn').onclick=()=>{
  document.getElementById('screen-feedback').classList.add('hidden');
  document.getElementById('screen-finish').classList.remove('hidden');
};
</script>
</body>
</html>
