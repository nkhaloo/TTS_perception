<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perception Experiment</title>
<style>
body {
  font-family: sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}
.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h1 { font-size: 24px; margin-top: 0; }
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 8px;
}
.btn-primary { background: #007acc; color: white; }
.btn-primary:disabled {
  background: #a0aec0; color: #e2e8f0; cursor: not-allowed;
}
.btn-secondary { background: #ccc; color: black; }
.hidden { display: none; }
.progress {
  height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden;
}
.progress > div {
  height: 100%; background: #007acc; width: 0; transition: width .2s ease;
}
textarea {
  width: 100%; height: 100px; margin-top: 8px; padding: 6px;
  border-radius: 4px; border: 1px solid #ccc; font-family: sans-serif;
}
.question-block {
  margin: 20px 0; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #ddd;
}
.question-block p { margin: 0 0 8px 0; font-weight: bold; }
.question-block label { display: block; margin: 4px 0; }
input[type="range"] {
  -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #aaa; cursor: pointer; margin-top: -5px; transition: background 0.2s;
}
input[type="range"].active::-webkit-slider-thumb { background: #007bff; }
input[type="range"]::-moz-range-thumb {
  width: 18px; height: 18px; border-radius: 50%; background: #aaa; transition: background 0.2s; cursor: pointer;
}
input[type="range"].active::-moz-range-thumb { background: #007bff; }
.scale-labels {
  display: flex; justify-content: space-between; font-size: 12px; color: #555; margin-top: 6px;
}
.scale-labels span { flex: 1; text-align: center; white-space: nowrap; }
</style>
</head>
<body>

<!-- Consent -->
<div class="card" id="screen-consent">
  <h1>Intro and Consent</h1>
  <p>Thank you for participating!</p>
  <p>We are testing A.I. generated voices trained on multiple dialects, voices, and genders, so your input about these traits is important for the continued development of voice assistants.</p>
  <p>This experiment will be somewhat repetitive — please pay close attention to each trial.</p>
  <p><strong>Important:</strong> Please wear <strong>headphones</strong> for the entire experiment. This is necessary for accurate sound perception. If you’re not sure what kind of headphones you have, don’t worry — you’ll be asked to specify that on the next screen.</p>
 <p>
   Before starting, please read the
   <a href="../consent/TTS_perception_consent_form.docx.pdf" target="_blank">
     Informed Consent Form
   </a>
   then check the box below once done.
 </p>
  <label><input type="checkbox" id="consentCheck"> I consent to participate</label>
  <br><br>

  <label for="prolificId"><strong>Please enter your Prolific ID:</strong></label><br>
  <input type="text" id="prolificId" placeholder="e.g., 60a1b2c3d4e5f6g7h8i9" style="width:100%; padding:8px; font-size:14px; margin-top:6px;">
  <br><br>

  <button class="btn btn-primary" id="consentBtn" disabled>Continue</button>

</div>

<!-- Headphone Info -->
<div class="card hidden" id="screen-headphones">
  <h1>Headphone Information</h1>
  <p><strong>Before continuing:</strong> Please ensure you are wearing headphones.</p>
  <p>For our records, please tell us what type of headphones you are using. Examples include:</p>
  <ul>
    <li>Apple AirPods / AirPods Pro</li>
    <li>Wired earbuds (e.g., Apple, Panasonic, etc.)</li>
    <li>Over-ear wired headphones (e.g., Sony, Bose)</li>
    <li>Bluetooth over-ear headphones (e.g., Beats, JBL, Bose QC)</li>
  </ul>
  <p>You can usually find your headphone type in your Bluetooth settings (for wireless) or on the product itself (for wired).</p>
  <div>
    <label><strong>Please type the name or description of your headphones below:</strong></label>
    <input type="text" id="headphoneInput" placeholder="e.g., Apple AirPods Pro, Wired Sony Over-Ear" style="width:100%; padding:8px; font-size:14px;">
  </div>
  <div style="margin-top:12px;">
    <label><input type="checkbox" id="confirmHeadphones"> I confirm that I am wearing headphones</label>
  </div>
  <br>
  <button class="btn btn-primary" id="headphoneNextBtn" disabled>Continue</button>
</div>

<!-- Audio Attention Check -->
<div class="card hidden" id="screen-audiocheck">
  <button class="btn btn-primary" id="playAudioCheckBtn">Play Audio</button>
  <audio id="audioCheckPlayer"></audio>
  <div class="question-block">
    <p>Play the audio and type the answer to the question you heard:</p>
    <input type="text" id="audioCheckResponse" style="width:300px; padding:6px;">
  </div>
  <button class="btn btn-primary" id="audioCheckNextBtn" disabled>Continue</button>
</div>

<!-- Trial Block -->
<div class="card hidden" id="screen-block">
  <div class="progress"><div id="progressBar"></div></div>
  <p>Please press the button to listen to the audio, then answer the questions below:</p>
  <button class="btn btn-primary" id="playBtn">Play Audio</button>
  <audio id="player" preload="auto"></audio>
  <div id="questionsContainer"></div>
  <div style="margin-top:12px;">
    <button class="btn btn-primary" id="nextBtn" disabled>Next</button>
  </div>
</div>

<!-- Demographics -->
<div class="card hidden" id="screen-demographics">
  <h1>Please answer the following questions about yourself</h1>
  <div id="demoQuestions"></div>
  <button class="btn btn-primary" id="demoNextBtn" disabled>Next</button>
</div>

<!-- Feedback -->
<div class="card hidden" id="screen-feedback">
  <h1>Final Feedback</h1>
  <textarea id="feedbackText"></textarea>
  <button class="btn btn-primary" id="feedbackNextBtn">Submit</button>
</div>

<!-- Finish -->
<div class="card hidden" id="screen-finish">
  <h1>All Done!</h1>
  <p>Thank you for participating in this study.</p>
  <p><strong>Your participation code:</strong> <code>CJUVEL1D</code></p>
  <p>
    Please click the link below to complete your submission on Prolific:
  </p>
  <p>
    <a href="https://app.prolific.com/submissions/complete?cc=CJUVEL1D" target="_blank" style="font-size:16px; color:#007acc; text-decoration:underline;">
      ➤ Click here to return to Prolific and submit your study
    </a>
  </p>
</div>

<script>
/* ===========================
   Config / Mapping
=========================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXRmnC8XnDryTN2S2UBXkqG93Y0YoV2-V56ZVxAe92GIIzHI112C4BnfSGDAPrItssiQ/exec";

const CONFIG = {
  assetsBase: '../data/soundfiles',
  attnBase: './audio_check',
  stimuliPersonality: ['passage'],
  stimuliRace: ['central','fronting','mono','raising'],
  suffix: '.mp3',
  bins:['BF','BM','WF','WM'],
  numsPerBin:8,
  questions:{
    Personality:[
      "How friendly does this speaker sound?",
      "How professional does this speaker sound?",
      "How funny does this speaker sound?",
      "How competent does this speaker sound?",
      "How trustworthy does this speaker sound?",
      "How pleasant does this speaker sound?",
      "How human-like was this voice?"
    ],
    Race:[
      {type:"radio-list",text:"What dialect region does the AI voice sound like?",options:["Midwestern U.S.","Northeastern U.S.","Northwestern U.S.","Southeastern U.S.","Southwestern U.S.","Non-American"]},
      {type:"radio-list",text:"What race does the AI voice sound like?",options:["Asian","Black","Latino/Hispanic","White"]},
      {type:"radio-list",text:"How old does the AI voice sound?",options:["18–24","25–34","35–44","45–54","55+"]},
      {type:"likert",text:"How feminine or masculine does the AI voice sound?",scaleMin:1,scaleMax:7}
    ]
  }
};

const Q2KEY = {
  "How friendly does this speaker sound?":"friendly",
  "How professional does this speaker sound?":"professional",
  "How funny does this speaker sound?":"funny",
  "How competent does this speaker sound?":"competent",
  "How trustworthy does this speaker sound?":"trustworthy",
  "How pleasant does this speaker sound?":"pleasant",
  "How human-like was this voice?":"human_like",
  "What dialect region does the AI voice sound like?":"dialect_region",
  "What race does the AI voice sound like?":"perceived_race",
  "How old does the AI voice sound?":"perceived_age",
  "How feminine or masculine does the AI voice sound?":"gender_scale"
};

/* ===========================
   Global State
=========================== */
const State={
  blocks:{},
  order:[],
  currentBlock:null,
  trialIndex:0,
  audioFinished:false,
  attnQueue:[],
  attnAnswers:[],
  participantId:null,
  headphoneType:"",
  demographics:{}
};

/* ===========================
   Helpers / Visuals
=========================== */
function setSliderBackground(slider){
  if(!slider.classList.contains('active')){slider.style.background='#ddd';return;}
  const min=Number(slider.min),max=Number(slider.max),val=Number(slider.value);
  const percent=((val-min)/(max-min))*100;
  slider.style.background=`linear-gradient(to right,#007bff 0%,#007bff ${percent}%,#ddd ${percent}%,#ddd 100%)`;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function filenameForTrial(t){ return `${t.speaker}_${t.stimulus}${CONFIG.suffix}`; }
function sendToGoogleSheet(obj){
  const fd = new FormData();
  for (const k in obj) fd.append(k, obj[k] ?? "");
  fetch(SCRIPT_URL, { method:"POST", body:fd }).catch(err=>console.error("Sheet POST error:", err));
}

/* ===========================
   Consent + Headphones
=========================== */
const consentCheck = document.getElementById('consentCheck');
const prolificInput = document.getElementById('prolificId');
const consentBtn = document.getElementById('consentBtn');

// Enable Continue only if both consent and Prolific ID entered
function updateConsentContinue() {
  consentBtn.disabled = !(consentCheck.checked && prolificInput.value.trim().length > 0);
}

consentCheck.onchange = updateConsentContinue;
prolificInput.oninput = updateConsentContinue;

consentBtn.onclick = () => {
  const idVal = prolificInput.value.trim();
  if (!idVal) {
    alert("Please enter your Prolific ID before continuing.");
    return;
  }
  State.participantId = idVal; // Use actual Prolific ID instead of random ID
  document.getElementById('screen-consent').classList.add('hidden');
  document.getElementById('screen-headphones').classList.remove('hidden');
};


const headphoneInput=document.getElementById('headphoneInput');
const confirmHeadphones=document.getElementById('confirmHeadphones');
const headphoneNextBtn=document.getElementById('headphoneNextBtn');
function updateHeadphoneContinue(){
  headphoneNextBtn.disabled=!(headphoneInput.value.trim() && confirmHeadphones.checked);
}
headphoneInput.oninput=updateHeadphoneContinue;
confirmHeadphones.onchange=updateHeadphoneContinue;

headphoneNextBtn.onclick=()=>{
  State.headphoneType=headphoneInput.value.trim();
  document.getElementById('screen-headphones').classList.add('hidden');
  prepareAttentionQueue();
  showAudioAttentionCheck(()=>{ startExperiment(); });
};

/* ===========================
   Attention Checks
=========================== */
function prepareAttentionQueue(){
  const urls=[];
  for(let i=1;i<=21;i++){ urls.push(`${CONFIG.attnBase}/${i}.mp3`); }
  State.attnQueue = shuffle(urls);
}
function nextAttentionAudio(){
  if(State.attnQueue.length===0) prepareAttentionQueue();
  return State.attnQueue.shift();
}
function showAudioAttentionCheck(onContinue){
  const card=document.getElementById('screen-audiocheck');
  const playBtn=document.getElementById('playAudioCheckBtn');
  const audio=document.getElementById('audioCheckPlayer');
  const input=document.getElementById('audioCheckResponse');
  const nextBtn=document.getElementById('audioCheckNextBtn');
  input.value=""; nextBtn.disabled=true;
  playBtn.disabled=false; playBtn.textContent='Play Audio';
  audio.src=nextAttentionAudio();
  audio.currentTime=0;
  playBtn.onclick=async()=>{
    try{ playBtn.disabled=true; playBtn.textContent='Playing...'; await audio.play(); }
    catch{ playBtn.disabled=false; playBtn.textContent='Play Audio';}
  };
  audio.onended=()=>{
    playBtn.disabled=true;
    playBtn.textContent='Audio finished';
  };
  input.oninput=()=>{ nextBtn.disabled=!input.value.trim(); };
  nextBtn.onclick=()=>{
    const ans=input.value.trim();
    if(!ans){ alert("Please type your answer before continuing."); return; }
    State.attnAnswers.push(ans);
    card.classList.add('hidden');
    onContinue && onContinue();
  };
  card.classList.remove('hidden');
}

/* ===========================
   Experiment Flow
=========================== */
function buildAllSpeakers(){
  const s=[];
  for(const b of CONFIG.bins){
    for(let n=1;n<=CONFIG.numsPerBin;n++){ s.push(`${b}${n}`); }
  }
  return s;
}
function sampleSpeakersPerBlock(all){
  const byBin=Object.fromEntries(CONFIG.bins.map(b=>[b,[]]));
  for(const sp of all){ byBin[sp.replace(/\d+$/,'')].push(sp); }
  CONFIG.bins.forEach(b=>shuffle(byBin[b]));
  const personality=[],race=[];
  CONFIG.bins.forEach(b=>{ personality.push(...byBin[b].slice(0,4)); race.push(...byBin[b].slice(4,8)); });
  return {personality,race};
}
function buildBlockTrials(speakers,stimuliList,blockName){
  const out=[];
  for(const sp of speakers){
    for(const st of stimuliList){
      const folder=(st==='passage')?'passage':st;
      out.push({
        block:blockName,
        speaker:sp,
        stimulus:st,
        url:`${CONFIG.assetsBase}/${folder}/${sp}_${st}${CONFIG.suffix}`
      });
    }
  }
  return shuffle(out);
}
function startExperiment(){
  const all=buildAllSpeakers();
  const {personality,race}=sampleSpeakersPerBlock(all);
  State.blocks={
    Personality:buildBlockTrials(personality,CONFIG.stimuliPersonality,'Personality'),
    Race:buildBlockTrials(race,CONFIG.stimuliRace,'Race')
  };
  State.order=['Personality','Race'];
  renderBlock('Personality');
}

/* ===========================
   Block / Trial Logic
=========================== */
const block=document.getElementById('screen-block');
const progressBar=document.getElementById('progressBar');
const player=document.getElementById('player');
const playBtn=document.getElementById('playBtn');
const nextBtn=document.getElementById('nextBtn');
const questionsContainer=document.getElementById('questionsContainer');

function renderQuestions(blockName){
  questionsContainer.innerHTML='';
  if(blockName==="Personality"){
    const qs=[...CONFIG.questions.Personality];
    shuffle(qs).forEach(q=>{
      const div=document.createElement('div');
      div.className='question-block';
      div.innerHTML=`<p>${q}</p>
        <input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
        <div class="scale-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>`;
      questionsContainer.appendChild(div);
    });
  } else {
    const qs=[...CONFIG.questions.Race];
    shuffle(qs).forEach((q,i)=>{
      const div=document.createElement('div');
      div.className='question-block';
      let html=`<p>${q.text}</p>`;
      if(q.type==="radio-list"){
        q.options.forEach(opt=>html+=`<label><input type="radio" name="r${i}" value="${opt}" disabled> ${opt}</label>`);
      } else if(q.type==="likert"){
        html += `
          <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold; color:#444; margin-bottom:4px;">
            <span>Most Feminine</span>
            <span>Most Masculine</span>
          </div>
          <input type="range" min="1" max="7" step="any" value="4" class="slider" data-touched="false" disabled>
          <div class="scale-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>`;
      }
      div.innerHTML=html;
      questionsContainer.appendChild(div);
    });
  }
  document.querySelectorAll('.slider').forEach(sl=>{
    setSliderBackground(sl);
    sl.oninput=()=>{sl.dataset.touched="true";sl.classList.add('active');setSliderBackground(sl);updateNextButtonState();};
  });
  document.querySelectorAll('input[type=radio]').forEach(inp=>inp.onchange=updateNextButtonState);
}
function disableInputs(disabled){document.querySelectorAll('#questionsContainer input').forEach(inp=>inp.disabled=disabled);}
function allAnswered(){
  if(State.currentBlock==="Personality") {
    return Array.from(document.querySelectorAll('.slider')).every(sl=>sl.dataset.touched==="true");
  }
  if(State.currentBlock==="Race"){
    return Array.from(document.querySelectorAll('.question-block')).every(b=>{
      const radios=b.querySelectorAll('input[type="radio"]');
      const slider=b.querySelector('input[type="range"]');
      if(radios.length>0) return Array.from(radios).some(r=>r.checked);
      if(slider) return slider.dataset.touched==="true";
      return true;
    });
  }
  return false;
}
function updateNextButtonState(){ nextBtn.disabled=!(State.audioFinished&&allAnswered()); }
function resetAnswers(){
  document.querySelectorAll('.slider').forEach(sl=>{sl.value=4;sl.dataset.touched="false";sl.disabled=true;setSliderBackground(sl);});
  document.querySelectorAll('input[type=radio]').forEach(r=>{r.checked=false;r.disabled=true;});
  nextBtn.disabled=true;
}
function currentTrials(){ return State.blocks[State.currentBlock]; }
function currentTrial(){ return currentTrials()[State.trialIndex]; }

function updateTrialUI(){
  const t=currentTrial(), total=currentTrials().length;
  progressBar.style.width=`${(State.trialIndex/total)*100}%`;
  renderQuestions(State.currentBlock);
  player.src=t.url;
  player.currentTime=0;
  State.audioFinished=false;
  resetAnswers();
  playBtn.disabled=false;
  playBtn.textContent='Play Audio';
  playBtn.onclick=async()=>{
    try{ playBtn.disabled=true; playBtn.textContent='Playing...'; await player.play(); }
    catch{ playBtn.disabled=false; playBtn.textContent='Play Audio'; }
  };
  player.onended=()=>{
    State.audioFinished=true;
    disableInputs(false);
    playBtn.disabled=true;
    playBtn.textContent='Audio finished';
    updateNextButtonState();
  };
}
function renderBlock(name){
  State.currentBlock=name;
  State.trialIndex=0;
  block.classList.remove('hidden');
  updateTrialUI();
  nextBtn.onclick=handleNext;
}

/* ===========================
   Attention Check Insertions & Next
=========================== */
function handleNext(){
  // Record current trial before advancing
  recordTrialResponses();

  State.trialIndex++;
  const total=currentTrials().length;
  const atEnd=State.trialIndex>=total;
  const mod4=(State.trialIndex%4===0);
  const pendingChecks=[];
  if(State.currentBlock==='Personality'){
    if(atEnd){pendingChecks.push('between-blocks');}
    else if(mod4){pendingChecks.push('post-trial');}
  } else if(State.currentBlock==='Race'&&mod4){pendingChecks.push('post-trial');}

  const proceedAfterChecks=()=>{
    if(State.trialIndex<total) updateTrialUI();
    else {
      const idx=State.order.indexOf(State.currentBlock);
      if(idx===0) renderBlock('Race');
      else { block.classList.add('hidden'); renderDemographics(); }
    }
  };
  if(pendingChecks.length>0){
    const runSeq=(i)=>{
      if(i>=pendingChecks.length){ block.classList.remove('hidden'); proceedAfterChecks(); return; }
      showAudioAttentionCheck(()=>runSeq(i+1));
    };
    block.classList.add('hidden');
    runSeq(0);
  } else proceedAfterChecks();
}

/* ===========================
   Demographics and Feedback
=========================== */
function renderDemographics(){
  const demo=document.getElementById('screen-demographics');
  demo.classList.remove('hidden');
  let html="";
  html+=`<div class="question-block"><p>Please select your age range.</p>`;
  ["18–24","25–34","35–44","45–54","55+"].forEach(opt=>{html+=`<label><input type="radio" name="age" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  html+=`<div class="question-block"><p>Which race/ethnicity do you most strongly identify with?</p>`;
  ["Asian American","Black American","Hispanic/Latino American","White American","Native American or other Indigenous culture","Other"].forEach(opt=>{html+=`<label><input type="checkbox" name="ethnicity" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  html+=`<div class="question-block"><p>What regional dialect do you believe is closest to the way you speak?</p>`;
  ["Midwestern U.S.","Northeastern U.S.","Northwestern U.S.","Southeastern U.S.","Southwestern U.S."].forEach(opt=>{html+=`<label><input type="radio" name="dialect" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  html+=`<div class="question-block"><p>What is/are your first language(s)?</p>`;
  ["English","English and another language"].forEach(opt=>{html+=`<label><input type="radio" name="firstlang" value="${opt}"> ${opt}</label>`;});
  html+=`<div id="otherLangBox" class="hidden"><p>Please enter the language(s) besides English that you grew up speaking:</p><textarea id="otherLangText"></textarea></div></div>`;

  // Gender with Other
  html+=`<div class="question-block"><p>What is your gender?</p>`;
  ["Male","Female","Non-binary","Other"].forEach(opt=>{html+=`<label><input type="radio" name="gender" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  // Speech/hearing with Prefer not to say
  html+=`<div class="question-block"><p>Do you have any speech or hearing disorders?</p>`;
  ["No","Yes","Prefer not to say"].forEach(opt=>{html+=`<label><input type="radio" name="speech" value="${opt}"> ${opt}</label>`;});
  html+=`<div id="speechDescBox" class="hidden"><p>Please briefly describe the speech or hearing disorder:</p><textarea id="speechDescText"></textarea></div></div>`;

  // Neurodivergence with Prefer not to say
  html+=`<div class="question-block"><p>Have you been diagnosed as neurodivergent by a medical professional?</p>`;
  ["No","Yes","Prefer not to say"].forEach(opt=>{html+=`<label><input type="radio" name="neuro" value="${opt}"> ${opt}</label>`;});
  html+=`<div id="neuroDescBox" class="hidden"><p>Please briefly state what kind of neurodivergence you have been diagnosed with:</p><textarea id="neuroDescText"></textarea></div></div>`;

  html+=`<div class="question-block"><p>Which technologies do you use regularly?</p>`;
  ["ChatGPT Voice Assistant","Google Gemini Voice","Amazon Alexa","Apple Siri","Microsoft Cortana","Voice-based navigation apps","Other text-to-speech software","None of the above"].forEach(opt=>{html+=`<label><input type="checkbox" name="tech" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  html+=`<div class="question-block"><p>How often do you use AI-based software or AI voice assistants?</p>`;
  ["Never","Less than once per week","A few times per week","About once per day","Several times per day"].forEach(opt=>{html+=`<label><input type="radio" name="aiuse" value="${opt}"> ${opt}</label>`;});
  html+=`</div>`;

  html+=`<div class="question-block"><p>What is your attitude towards AI-based software or AI voice assistants?</p>`;
  for(let v=1;v<=7;v++){let label="";if(v===1)label="Very negative";if(v===4)label="Neutral";if(v===7)label="Very positive";html+=`<label><input type="radio" name="aiatt" value="${v}"> ${v} ${label}</label>`;}
  html+=`</div>`;

  document.getElementById('demoQuestions').innerHTML=html;

  const btn=document.getElementById('demoNextBtn');

  function toggleConditional(name,val,box){
    document.querySelectorAll(`input[name="${name}"]`).forEach(inp=>{
      inp.addEventListener('change',()=>{
        const boxEl=document.getElementById(box);
        const checkedVal=(document.querySelector(`input[name="${name}"]:checked`)||{}).value || "";
        if(checkedVal===val){ boxEl.classList.remove('hidden'); }
        else { boxEl.classList.add('hidden'); const ta=boxEl.querySelector('textarea'); if(ta) ta.value=""; }
        updateBtn();
      });
    });
  }
  // Only show text fields when "Yes" selected (not required for "Prefer not to say")
  toggleConditional('firstlang','English and another language','otherLangBox');
  toggleConditional('speech','Yes','speechDescBox');
  toggleConditional('neuro','Yes','neuroDescBox');

  function allDemoAnswered(){
    const age=document.querySelector('input[name="age"]:checked');
    const eth=document.querySelectorAll('input[name="ethnicity"]:checked').length>0;
    const dialect=document.querySelector('input[name="dialect"]:checked');
    const gender=document.querySelector('input[name="gender"]:checked');
    const first=document.querySelector('input[name="firstlang"]:checked');
    const speech=document.querySelector('input[name="speech"]:checked');
    const neuro=document.querySelector('input[name="neuro"]:checked');
    const tech=document.querySelectorAll('input[name="tech"]:checked').length>0;
    const aiuse=document.querySelector('input[name="aiuse"]:checked');
    const aiatt=document.querySelector('input[name="aiatt"]:checked');
    if(!age||!eth||!dialect||!gender||!first||!speech||!neuro||!tech||!aiuse||!aiatt) return false;
    if(first.value==="English and another language"&&!document.getElementById('otherLangText').value.trim()) return false;
    if(speech.value==="Yes"&&!document.getElementById('speechDescText').value.trim()) return false;
    if(neuro.value==="Yes"&&!document.getElementById('neuroDescText').value.trim()) return false;
    return true;
  }
  function updateBtn(){ btn.disabled=!allDemoAnswered(); }
  document.querySelectorAll('#demoQuestions input,#demoQuestions textarea').forEach(el=>{
    el.addEventListener('input',updateBtn);
    el.addEventListener('change',updateBtn);
  });
  btn.disabled=true;
  btn.onclick=()=>{
    if(allDemoAnswered()){
      State.demographics = collectDemographics(); // store; send on final submit
      demo.classList.add('hidden');
      document.getElementById('screen-feedback').classList.remove('hidden');
    } else alert("Please complete all required questions before continuing.");
  };
}

/* ===========================
   Final Screen
=========================== */
document.getElementById('feedbackNextBtn').onclick=()=>{
  const feedback = document.getElementById('feedbackText').value || "";
  submitDemographicsAndFinalize(feedback);
  document.getElementById('screen-feedback').classList.add('hidden');
  document.getElementById('screen-finish').classList.remove('hidden');
};

/* ===========================
   Recording & Submission
=========================== */
function recordTrialResponses(){
  if(!State.currentBlock) return;
  const t=currentTrial(); if(!t) return;

  const data = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: State.currentBlock,
    trial_index: State.trialIndex + 1,
    speaker: t.speaker,
    stimulus: t.stimulus,
    audio_file: filenameForTrial(t)
  };

  document.querySelectorAll('#questionsContainer .question-block').forEach(b=>{
    const qText = (b.querySelector('p')?.innerText || "").trim();
    const key = Q2KEY[qText];
    if(!key) return;
    const slider = b.querySelector('input[type="range"]');
    const checked = b.querySelector('input[type="radio"]:checked');
    if(slider) data[key] = slider.value;
    else if(checked) data[key] = checked.value;
  });

  sendToGoogleSheet(data);
}

function collectDemographics(){
  const getRadio = name => (document.querySelector(`input[name="${name}"]:checked`) || {}).value || "";
  const getChecks = name => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(i=>i.value).join("; ");

  const first = getRadio("firstlang");
  const speech = getRadio("speech");
  const neuro = getRadio("neuro");

  return {
    participant_id: State.participantId,
    block: "Demographics",
    age: getRadio("age"),
    ethnicity: getChecks("ethnicity"),
    dialect: getRadio("dialect"),
    first_language: first,
    other_languages: first==="English and another language" ? (document.getElementById('otherLangText').value || "") : "",
    gender: getRadio("gender"),
    speech_disorder: speech,
    speech_disorder_desc: speech==="Yes" ? (document.getElementById('speechDescText').value || "") : "",
    neurodivergent: neuro,
    neurodivergent_desc: neuro==="Yes" ? (document.getElementById('neuroDescText').value || "") : "",
    technologies_used: getChecks("tech"),
    ai_use_frequency: getRadio("aiuse"),
    ai_attitude: getRadio("aiatt")
  };
}

function submitDemographicsAndFinalize(finalFeedbackText){
  const demo = State.demographics || {};
  const out = {
    participant_id: demo.participant_id || State.participantId,
    prolific_id: State.participantId,
    block: "Demographics",
    headphone_type: State.headphoneType || "",
    age: demo.age || "",
    ethnicity: demo.ethnicity || "",
    dialect: demo.dialect || "",
    first_language: demo.first_language || "",
    other_languages: demo.other_languages || "",
    gender: demo.gender || "",
    speech_disorder: demo.speech_disorder || "",
    speech_disorder_desc: demo.speech_disorder_desc || "",
    neurodivergent: demo.neurodivergent || "",
    neurodivergent_desc: demo.neurodivergent_desc || "",
    technologies_used: demo.technologies_used || "",
    ai_use_frequency: demo.ai_use_frequency || "",
    ai_attitude: demo.ai_attitude || "",
    final_feedback: finalFeedbackText || ""
  };

  // Bundle all attention checks into this final row
  for(let i=1;i<=21;i++){
    out[`attention_check_${i}`] = State.attnAnswers[i-1] || "";
  }

  sendToGoogleSheet(out);
}
</script>
</body>
</html>
