#store top 15 features
top15_features <- importance_all %>%
slice_max(Gain, n = 15) %>%
pull(Feature)
# define cv runner
top_15_cv <- function(seed, nfold = 5) {
fold_map <- make_speaker_folds(
df_chunked_kitchensink,
group_col = "speaker",
nfold = nfold,
seed = seed
)
df_cv <- df_chunked_kitchensink %>%
left_join(fold_map, by = "speaker")
fit_xgb_groupcv_folds(df_cv, top15_features) %>%
mutate(model = "top15", seed = seed)
}
#set number of trials and seed
n_trials <- 50
seeds <- 1:n_trials
ks_out <- map(seeds, ~ top_15_cv(seed = .x, nfold = 5))
ks_results <- bind_rows(ks_out)
# summarise across folds within each seed, then across seeds
ks_seed_level <- ks_results %>%
group_by(seed) %>%
summarise(mean_acc = mean(accuracy), .groups = "drop")
ks_seed_level %>%
summarise(
mean_acc = mean(mean_acc),
n_trials = n(),
.groups = "drop"
)
##### try random forrest to see increase in accruacy #####
library(ranger)
rf_cv <- function(seed, nfold = 5) {
# speaker-wise folds for this seed
fold_map <- make_speaker_folds(
df_chunked_kitchensink,
group_col = "speaker",
nfold = nfold,
seed = seed
)
df_cv <- df_chunked_kitchensink %>%
left_join(fold_map, by = "speaker") %>%
mutate(y_factor = factor(y, levels = c(0, 1), labels = c("0", "1")))
fold_levels <- sort(unique(df_cv$fold))
fold_acc <- map_dbl(fold_levels, function(fk) {
train_df <- df_cv %>% filter(fold != fk)
test_df  <- df_cv %>% filter(fold == fk)
train_df <- train_df %>% drop_na(all_of(feature_cols_kitchensink), y_factor)
test_df  <- test_df  %>% drop_na(all_of(feature_cols_kitchensink), y_factor)
rf_mod <- ranger(
formula = as.formula(
paste("y_factor ~", paste(feature_cols_kitchensink, collapse = " + "))
),
data = train_df,
probability = TRUE,
seed = 999
)
p1 <- predict(rf_mod, data = test_df)$predictions[, "1"]
pred <- ifelse(p1 >= 0.5, 1, 0)
mean(pred == test_df$y)
})
tibble(
seed = seed,
mean_acc = mean(fold_acc)
)
}
# run 50 CV rounds
rf_results_50 <- map_dfr(seeds, rf_cv)
# summary (directly comparable to your XGB results)
rf_results_50 %>%
summarise(
mean_acc = mean(mean_acc)
)
######plotting mean structure #####
# look at F1 and F2 mean structure
vars_formant <- c("sF1", "sF2")
n_bins <- 9
# reload acoustic df
df_formant <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/acoustic_data/output.csv") %>%
mutate(speaker = substr(Filename, 1, 3)) %>%
left_join(ground_truth, by = "speaker") %>%
select(
Filename, Label, seg_Start, seg_End,
sF1, sF2,
speaker, ground_truth_label
) %>%
mutate(
modality = case_when(
str_ends(Label, "_hc") ~ "breathy_creaky",
str_ends(Label, "_c")  ~ "creaky",
str_ends(Label, "_h")  ~ "breathy",
TRUE                   ~ "modal"
),
Label = str_remove(Label, "_(hc|c|h)$")
) %>%
filter(str_detect(Filename, "central|mono|raising|fronting")) %>%
left_join(vowel_codes, by = "Label") %>%
mutate(
gender = substr(Filename, 2, 2),
gender = case_when(
gender == "F" ~ "female",
gender == "M" ~ "male",
TRUE ~ NA_character_
),
vowel = case_when(
vowel %in% c("ɑh", "ah") ~ "ɑ",
vowel == "ih"            ~ "ɪ",
vowel == "ai"            ~ "æi",
vowel %in% c("ɑ'", "a")  ~ "æ",
TRUE ~ vowel
)
) %>%
drop_na(vowel) %>%
filter(
gender == "male",
ground_truth_label != "Ambiguous",
is.finite(sF1),
is.finite(sF2)
)
df_norm9_F12 <- df_formant %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(
n_ms == 1,
0.5,
(row_number() - 1) / (n_ms - 1)
),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
df_token_F12 <- df_norm9_F12 %>%
pivot_longer(
all_of(vars_formant),
names_to = "feature",
values_to = "value"
) %>%
group_by(
Filename, Label, seg_Start, seg_End,
vowel, ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
)
df_mean9_F12 <- df_token_F12 %>%
group_by(vowel, ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins,
feature_label = recode(feature, sF1 = "F1", sF2 = "F2")
)
ggplot(
df_mean9_F12,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_grid(feature_label ~ vowel, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1),
labels = scales::label_number(
accuracy = 0.1
)
) +
labs(
x = "Normalized Time",
y = "Mean formant value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal(base_size = 13) +   # ← FIRST
theme(
## VOWEL labels (top strips)
strip.text.x = element_text(
size = 18,
face = "bold"
),
panel.spacing.x = unit(1.5, "lines"),
strip.text.y = element_text(
size = 18,
face = "bold",
angle = 0
),
strip.placement = "outside",
axis.text.x = element_text(size = 13),
axis.text.y = element_text(size = 14)
)
# plot top voice quality features
df_clean_male <- df_clean %>%
filter(gender == "male")
vars_to_plot <- c("H1Res", "H2KH5Kc", "H42Kc", "sF4", "H2H4c", "CPP")
n_bins <- 9
df_norm9 <- df_clean_male %>%
select(Filename, speaker, ground_truth_label, vowel, Label, modality, seg_Start, seg_End,
all_of(vars_to_plot)) %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(n_ms == 1, 0.5, (row_number() - 1) / (n_ms - 1)),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*") %>%
str_replace("^H2H4c$", "H2*–H4*") %>%
str_replace("sF4", "F4")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
best_cfg
view(best_cfg)
ks_seed_level %>%
summarise(
mean_acc = mean(mean_acc),
n_trials = n(),
.groups = "drop"
)
n_used_features <- importance_all %>% nrow()
n_used_features
# Look at top features
importance_pretty <- importance_all %>%
mutate(
Feature_label = Feature %>%
# chunk labels FIRST
str_replace("_beg$", " (onset)") %>%
str_replace("_mid$", " (midpoint)") %>%
str_replace("_end$", " (offset)") %>%
# identify centered features
str_replace("_vmc$", "") %>%
# remove mean marker
str_replace("_mean_", "_") %>%
str_replace("_mean$", "") %>%
# CoV formatting (AFTER chunk handling)
str_replace("_cov_", " CoV ") %>%
str_replace("_cov$", " CoV") %>%
# acoustic renames
str_replace("^H1Res", "Residual H1*") %>%
str_replace("^H2KH5Kc", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc", "H4*–H2kHz*") %>%
str_replace("^H2H4c", "H2*–H4*") %>%
str_replace("^CPP", "CPP") %>%
str_replace("^DF", "Formant Dispersion") %>%
str_replace("^s", "") %>%
# vowel dummies
str_replace("^vowel_", "Vowel = ") %>%
# cleanup
str_replace_all("_", " ") %>%
str_squish()
)
top15_pretty <- importance_pretty %>%
slice_max(Gain, n = 15) %>%
arrange(Gain)
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
# Look at top features
importance_pretty <- importance_all %>%
mutate(
Feature_label = Feature %>%
# identify centered features
str_replace("_vmc$", "") %>%
# remove mean marker
str_replace("_mean_", "_") %>%
str_replace("_mean$", "") %>%
# CoV formatting
str_replace("_cov_", " CoV ") %>%
str_replace("_cov$", " CoV") %>%
# acoustic renames
str_replace("^H1Res", "Residual H1*") %>%
str_replace("^H2KH5Kc", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc", "H4*–H2kHz*") %>%
str_replace("^H2H4c", "H2*–H4*") %>%
str_replace("^CPP", "CPP") %>%
str_replace("^DF", "Formant Dispersion") %>%
str_replace("^s", "") %>%
# chunk labels
str_replace("_beg$", " (onset)") %>%
str_replace("_mid$", " (midpoint)") %>%
str_replace("_end$", " (offset)") %>%
# vowel dummies
str_replace("^vowel_", "Vowel = ") %>%
# cleanup
str_replace_all("_", " ") %>%
str_squish()
)
top15_pretty <- importance_pretty %>%
slice_max(Gain, n = 15) %>%
arrange(Gain)
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
# Look at top features
importance_pretty <- importance_all %>%
mutate(
Feature_label = Feature %>%
# identify centered features
str_replace("_vmc$", "") %>%
# remove mean marker
str_replace("_mean_", "_") %>%
str_replace("_mean$", "") %>%
# CoV formatting
str_replace("_cov_", " CoV ") %>%
str_replace("_cov$", " CoV") %>%
# acoustic renames
str_replace("^H1Res", "Residual H1*") %>%
str_replace("^H2KH5Kc", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc", "H4*–H2kHz*") %>%
str_replace("^H2H4c", "H2*–H4*") %>%
str_replace("^CPP", "CPP") %>%
str_replace("^DF", "Formant Dispersion") %>%
str_replace("^s", "") %>%
# vowel dummies
str_replace("^vowel_", "Vowel = ") %>%
# cleanup underscores first
str_replace_all("_", " ") %>%
# ✅ chunk labels as standalone tokens (works for both mean + CoV)
str_replace_all("\\bbeg\\b", "onset") %>%
str_replace_all("\\bmid\\b", "midpoint") %>%
str_replace_all("\\bend\\b", "offset") %>%
str_squish()
)
top15_pretty <- importance_pretty %>%
slice_max(Gain, n = 15) %>%
arrange(Gain)
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
ggplot(
df_mean9_F12,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_grid(feature_label ~ vowel, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1),
labels = scales::label_number(
accuracy = 0.1
)
) +
labs(
x = "Normalized Time",
y = "Mean formant value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal(base_size = 13) +   # ← FIRST
theme(
## VOWEL labels (top strips)
strip.text.x = element_text(
size = 18,
face = "bold"
),
panel.spacing.x = unit(1.5, "lines"),
strip.text.y = element_text(
size = 18,
face = "bold",
angle = 0
),
strip.placement = "outside",
axis.text.x = element_text(size = 13),
axis.text.y = element_text(size = 14)
)
best_cfg
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
