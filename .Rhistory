mean(pred == y[test_idx])
})
fold_levels <- sort(unique(df2$fold))
tibble(fold = fold_levels, accuracy = fold_acc)
}
# Repeated speaker-wise CV comparison
run_one_trial <- function(seed, nfold = 5) {
fold_map <- make_speaker_folds(df_whole, group_col = "speaker", nfold = nfold, seed = seed)
df_whole_cv <- df_whole %>% left_join(fold_map, by = "speaker")
df_chunked_cv <- df_chunked_male %>% left_join(fold_map, by = "speaker")
common_speakers <- intersect(unique(df_whole_cv$speaker), unique(df_chunked_cv$speaker))
df_whole_cv   <- df_whole_cv   %>% filter(speaker %in% common_speakers)
df_chunked_cv <- df_chunked_cv %>% filter(speaker %in% common_speakers)
stopifnot(!any(is.na(df_whole_cv$fold)))
stopifnot(!any(is.na(df_chunked_cv$fold)))
stopifnot(setequal(unique(df_whole_cv$fold), unique(df_chunked_cv$fold)))
folds_whole <- fit_xgb_groupcv_folds(df_whole_cv, feature_cols_whole) %>%
mutate(model = "whole", seed = seed)
folds_chunked <- fit_xgb_groupcv_folds(df_chunked_cv, feature_cols_chunked) %>%
mutate(model = "chunked", seed = seed)
wide <- bind_rows(folds_whole, folds_chunked) %>%
select(seed, fold, model, accuracy) %>%
pivot_wider(names_from = model, values_from = accuracy) %>%
mutate(delta = chunked - whole)
list(
fold_level = wide,
seed_level = tibble(
seed = seed,
mean_whole = mean(wide$whole),
mean_chunked = mean(wide$chunked),
mean_delta = mean(wide$delta)
)
)
}
# choose number of trials
n_trials <- 50
seeds <- 1:n_trials
trial_out <- map(seeds, ~ run_one_trial(seed = .x, nfold = 5))
fold_level_results <- map_df(trial_out, "fold_level")
seed_level_results <- map_df(trial_out, "seed_level")
# Summaries
seed_level_results %>%
summarise(
mean_whole   = mean(mean_whole),
mean_chunked = mean(mean_chunked),
avg_delta    = mean(mean_delta),
sd_delta     = sd(mean_delta),
n_pos        = sum(mean_delta > 0),
.groups = "drop"
)
# Inference on seed-level deltas
t.test(seed_level_results$mean_delta)
wilcox.test(seed_level_results$mean_delta, mu = 0)
# get importance on mean model
dmat_all <- xgb.DMatrix(
data = as.matrix(df_chunked_male[, feature_cols_chunked]),
label = df_chunked_male$y
)
model_chunked_all <- xgboost(
data = dmat_all,
nrounds = 50,
objective = "binary:logistic",
max_depth = 3,
eta = 0.1,
subsample = 0.8,
colsample_bytree = 0.8,
verbose = 0
)
importance_all <- xgb.importance(
feature_names = feature_cols_chunked,
model = model_chunked_all
)
top15_chunked <- importance_all %>%
slice_max(Gain, n = 15) %>%
arrange(Gain) %>%
mutate(
Feature_label = Feature %>%
# remove mean marker anywhere it occurs
str_replace_all("_mean_", "_") %>%   # keep separators stable
str_replace_all("_mean$", "") %>%    # just in case
# mark CoV (handles both _cov_ and _cov)
str_replace_all("_cov_", "_CoV_") %>%
str_replace_all("_cov$", "_CoV") %>%
# now rename acoustic feature stems (before chunk labeling)
str_replace("^H1Res", "Residual H1*") %>%
str_replace("^H2KH5Kc", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc", "H4*–H2kHz*") %>%
str_replace("^H2H4c", "H2*–H4*") %>%
str_replace("^CPP", "CPP") %>%
str_replace("^s", "") %>%
# convert trailing chunk marker robustly:
# matches either "_beg" or "beg" at end (same for mid/end)
str_replace("(_)?beg$", " (onset)") %>%
str_replace("(_)?mid$", " (mid point)") %>%
str_replace("(_)?end$", " (offset)") %>%
# clean up leftover underscores before/around CoV
str_replace_all("_CoV_", " CoV ") %>%
str_replace_all("_CoV", " CoV") %>%
str_replace_all("_", " ") %>%
str_squish()
)
# plot importance
ggplot(
top15_chunked,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Acoustic feature"
) +
theme_minimal()
# plot top features
df_clean_male <- df_clean %>%
filter(gender == "male")
vars_to_plot <- c("H1Res", "H2KH5Kc", "H42Kc", "DF")
n_bins <- 9
df_norm9 <- df_clean_male %>%
select(Filename, speaker, ground_truth_label, vowel, Label, modality, seg_Start, seg_End,
all_of(vars_to_plot)) %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(n_ms == 1, 0.5, (row_number() - 1) / (n_ms - 1)),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*") %>%
str_replace("^DF$", " Formant Dispersion")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
theme_minimal()
# cohen's d after elbow
cohens_d <- function(x, group) {
x1 <- x[group == "Black"]
x2 <- x[group == "White"]
m1 <- mean(x1, na.rm = TRUE)
m2 <- mean(x2, na.rm = TRUE)
s1 <- sd(x1, na.rm = TRUE)
s2 <- sd(x2, na.rm = TRUE)
sp <- sqrt(((length(x1) - 1) * s1^2 + (length(x2) - 1) * s2^2) /
(length(x1) + length(x2) - 2))
(m1 - m2) / sp
}
features_to_validate <- c(
"H1Res_mean_beg",
"H2KH5Kc_mean_mid",
"H1Res_mean_end",
"H42Kc_mean_end",
"H1Res_mean_mid",
"DF_cov_beg"
)
d_results <- map_df(
features_to_validate,
function(feat) {
df_chunked_male %>%
group_by(vowel) %>%
summarise(
d = cohens_d(.data[[feat]], ground_truth_label),
feature = feat,
.groups = "drop"
)
}
)
d_summary <- d_results %>%
group_by(feature) %>%
summarise(
mean_d   = mean(d, na.rm = TRUE),
median_d = median(d, na.rm = TRUE),
n_pos    = sum(d > 0, na.rm = TRUE),
n_neg    = sum(d < 0, na.rm = TRUE),
.groups  = "drop"
) %>%
arrange(desc(abs(mean_d)))
d_results
d_summary
# per trait lm
df_whole <- df_whole %>%
mutate(ground_truth_label = factor(ground_truth_label, levels = c("White", "Black")))
features_lmm <- features_to_validate_whole
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_whole
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
view(df_chunked_male)
df_chunked_male$H1Res_mean_beg
d_results <- map_df(
features_to_validate,
function(feat) {
df_chunked_male %>%
group_by(vowel) %>%
summarise(
d = cohens_d(.data[[feat]], ground_truth_label),
feature = feat,
.groups = "drop"
)
}
)
d_summary <- d_results %>%
group_by(feature) %>%
summarise(
mean_d   = mean(d, na.rm = TRUE),
median_d = median(d, na.rm = TRUE),
n_pos    = sum(d > 0, na.rm = TRUE),
n_neg    = sum(d < 0, na.rm = TRUE),
.groups  = "drop"
) %>%
arrange(desc(abs(mean_d)))
d_results
d_summary
d_summary
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
theme_minimal()
theme_minimal()
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
# per trait lm
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_whole
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
# per trait lm
df_chunked_male_lm <- df_chunked_male %>%
mutate(ground_truth_label = factor(ground_truth_label, levels = c("White", "Black")))
features_lmm <- features_to_validate
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_whole
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
features_lmm <- features_to_validate
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_whole
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_chunked_male_lm
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
lmm_results
features_lmm <- c(
features_to_validate,
"DF_cov_beg"
)
lmm_results <- map_df(
features_lmm,
function(feat) {
mod <- lmer(
as.formula(paste(feat, "~ ground_truth_label + (1 | speaker) + (1 | vowel)")),
data = df_chunked_male_lm
)
cf <- summary(mod)$coefficients
p  <- cf["ground_truth_labelBlack", "Pr(>|t|)"]
tibble(
feature  = feat,
estimate = cf["ground_truth_labelBlack", "Estimate"],
se       = cf["ground_truth_labelBlack", "Std. Error"],
t        = cf["ground_truth_labelBlack", "t value"],
p        = p,
sig      = case_when(
p < 0.001 ~ "***",
p < 0.01  ~ "**",
p < 0.05  ~ "*",
p < 0.1   ~ ".",
TRUE      ~ ""
)
)
}
)
lmm_results
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
df
view
view(df)
