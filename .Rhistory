slice_max(Gain, n = 15) %>%
pull(Feature)
run_one_trial_top15(seed = 1, nfold = 5)
top15_features
# ============================================================
# TOP-15 MODEL: 50-trial speaker-wise CV
# ============================================================
# (1) Define the CV runner if you haven't already
run_one_trial_top15 <- function(seed, nfold = 5) {
fold_map <- make_speaker_folds(
df_chunked_kitchensink,
group_col = "speaker",
nfold = nfold,
seed = seed
)
df_cv <- df_chunked_kitchensink %>%
left_join(fold_map, by = "speaker")
fit_xgb_groupcv_folds(df_cv, top15_features) %>%
mutate(model = "top15", seed = seed)
}
# (2) Run 50 trials
n_trials <- 50
seeds <- 1:n_trials
top15_results <- purrr::map_df(seeds, ~ run_one_trial_top15(seed = .x, nfold = 5))
# (3) Seed-level mean accuracy (averaging across folds)
top15_seed_level <- top15_results %>%
group_by(seed) %>%
summarise(mean_acc = mean(accuracy), .groups = "drop")
# Overall summary
top15_seed_level %>%
summarise(
mean_acc = mean(mean_acc),
sd_acc   = sd(mean_acc),
n_trials = n(),
.groups = "drop"
)
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
# plot importance
ggplot(
top15_chunked,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Acoustic feature"
) +
theme_minimal()
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
df_norm9 <- df_clean_male %>%
select(Filename, speaker, ground_truth_label, vowel, Label, modality, seg_Start, seg_End,
all_of(vars_to_plot)) %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(n_ms == 1, 0.5, (row_number() - 1) / (n_ms - 1)),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
vars_to_plot <- c("H1Res", "H2KH5Kc", "H42Kc")
df_norm9 <- df_clean_male %>%
select(Filename, speaker, ground_truth_label, vowel, Label, modality, seg_Start, seg_End,
all_of(vars_to_plot)) %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(n_ms == 1, 0.5, (row_number() - 1) / (n_ms - 1)),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
df_chunked
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*") %>%
str_replace("^H2H4c$", "H2*–H4*")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
vars_to_plot <- c("H1Res", "H2KH5Kc", "H42Kc", "sF4", "H2H4c")
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*") %>%
str_replace("^H2H4c$", "H2*–H4*")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
df_clean_male <- df_clean %>%
filter(gender == "male")
vars_to_plot <- c("H1Res", "H2KH5Kc", "H42Kc", "sF4", "H2H4c")
n_bins <- 9
df_norm9 <- df_clean_male %>%
select(Filename, speaker, ground_truth_label, vowel, Label, modality, seg_Start, seg_End,
all_of(vars_to_plot)) %>%
group_by(Filename, Label, seg_Start, seg_End) %>%
mutate(
n_ms = n(),
t_norm = ifelse(n_ms == 1, 0.5, (row_number() - 1) / (n_ms - 1)),
t_bin = pmin(n_bins, floor(t_norm * n_bins) + 1)
) %>%
ungroup()
df_mean9 <- df_norm9 %>%
pivot_longer(all_of(vars_to_plot), names_to = "feature", values_to = "value") %>%
group_by(
Filename, Label, seg_Start, seg_End,
ground_truth_label, feature, t_bin
) %>%
summarise(
token_mean = mean(value, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(ground_truth_label, feature, t_bin) %>%
summarise(
mean_value = mean(token_mean, na.rm = TRUE),
sd_value   = sd(token_mean, na.rm = TRUE),
n_tokens   = sum(!is.na(token_mean)),
se_value   = sd_value / sqrt(n_tokens),
ci_low     = mean_value - 1.96 * se_value,
ci_high    = mean_value + 1.96 * se_value,
.groups = "drop"
) %>%
mutate(
t_norm_center = (t_bin - 0.5) / n_bins
) %>%
mutate(
feature_label = feature %>%
str_replace("^H1Res$", "Residual H1*") %>%
str_replace("^H2KH5Kc$", "H2kHz*–H5kHz*") %>%
str_replace("^H42Kc$", "H4*–H2kHz*") %>%
str_replace("^H2H4c$", "H2*–H4*")
)
ggplot(
df_mean9,
aes(
x = t_norm_center,
y = mean_value,
color = ground_truth_label,
fill  = ground_truth_label
)
) +
geom_ribbon(
aes(ymin = ci_low, ymax = ci_high),
alpha = 0.2,
color = NA,
show.legend = FALSE
) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
facet_wrap(~ feature_label, scales = "free_y") +
scale_x_continuous(
breaks = seq(0, 1, by = 0.25),
limits = c(0, 1)
) +
labs(
x = "Normalized Time",
y = "Mean normalized value",
color = "Perceptually-Assigned Race"
) +
guides(fill = "none") +
theme_minimal()
top15_seed_level %>%
summarise(
mean_acc = mean(mean_acc),
sd_acc   = sd(mean_acc),
n_trials = n(),
.groups = "drop"
)
# summarize accuracy
top15_seed_level <- top15_results %>%
group_by(seed) %>%
summarise(mean_acc = mean(accuracy), .groups = "drop")
top15_seed_level %>%
summarise(
mean_acc = mean(mean_acc),
sd_acc   = sd(mean_acc),
n_trials = n(),
.groups = "drop"
)
ggplot(
top15_pretty,
aes(x = Gain, y = reorder(Feature_label, Gain))
) +
geom_col(fill = "steelblue") +
labs(
x = "Gain",
y = "Feature"
) +
theme_minimal(base_size = 13)
