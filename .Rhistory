scale_y_reverse("F1 (Hz)") +
theme_classic(base_size = 16) +
ggtitle(paste("F1–F2 Trajectory (Label × Gender) for vowel /", v, "/", sep = "")) +
theme(legend.position = "right")
print(p)
}
library(tidyverse)
library(mgcv)
library(itsadug)
# ---------------------
# Load ground truth csv
ground_truth <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/acoustic_data/formants/ground_truth_label.csv")
# ---------------------
# Load acoustic csv
df <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/acoustic_data/formants/output_all.csv") %>%
mutate(speaker = substr(Filename, 1, 3))
# ---------------------
# join and build df
df <- df %>%
left_join(ground_truth, by = "speaker") %>%
select(
Filename, Label, seg_Start, seg_End,
H1c, H2H4c, H42Kc, H2KH5Kc,
CPP, Energy,
HNR05, HNR15, HNR25, HNR35,
sF0, sF1, sF2, sF3, sF4,
epoch, soe,
speaker, ground_truth_label, mean_gender_scale
) %>%
filter(
if_all(
-c(soe, epoch),
~ .x != 0
)
) %>%
mutate(
modality = case_when(
str_ends(speaker, "hc") ~ "breathy_creaky",
str_ends(speaker, "c")  ~ "creaky",
str_ends(speaker, "h")  ~ "breathy",
TRUE ~ "modal"
)
) %>%
filter(str_detect(Filename, "central|mono|raising|fronting")) %>%
mutate(
sentence_type = case_when(
str_detect(Filename, "central")  ~ "central",
str_detect(Filename, "mono")     ~ "mono",
str_detect(Filename, "raising")  ~ "raising",
str_detect(Filename, "fronting") ~ "fronting",
TRUE ~ NA_character_
)
)
df <- df %>%
select(
Filename,
Label,
ground_truth_label,
mean_gender_scale,
modality,
sentence_type,
everything()
)
# ---------------------
# add vowel code
vowel_codes <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/metadata/vowel_codes.csv") %>%
rename(Label = "code") %>%
mutate(Label = as.character(Label))
# join
df <- df %>%
left_join(vowel_codes, by = "Label")
# ---------------------
# create ground truth gender column
df <- df %>%
mutate(
gender = substr(Filename, 2, 2),
gender = case_when(
gender == "F" ~ "female",
gender == "M" ~ "male",
TRUE ~ NA_character_
)
)
# ---------------------
# add normalized time
df <- df %>%
mutate(
seg_Start_sec = seg_Start / 1000,
seg_End_sec   = seg_End   / 1000
) %>%
group_by(Filename) %>%
mutate(
time_sec = seq(seg_Start_sec[1], seg_End_sec[1], length.out = n()),
normalized_time = (time_sec - seg_Start_sec[1]) /
(seg_End_sec[1] - seg_Start_sec[1])
) %>%
ungroup()
# ---------------------
# fix vowel names
df <- df %>%
mutate(
vowel = case_when(
vowel %in% c("ɑh","ah") ~ "ɑ",
vowel == "ih"           ~ "ɪ",
vowel == "ai"           ~ "æi",
vowel == "ɑ'"           ~ "æ",
TRUE ~ vowel
)
) %>%
drop_na(vowel)
# ---------------------
# filter out outliers
is_not_outlier_mad <- function(x, k = 3.5) {
med <- median(x, na.rm = TRUE)
mad_val <- mad(x, constant = 1, na.rm = TRUE)
abs(x - med) < k * mad_val
}
acoustic_vars <- c(
"H1c", "H2H4c", "H42Kc", "H2KH5Kc",
"CPP", "Energy",
"HNR05", "HNR15", "HNR25", "HNR35",
"sF0", "sF1", "sF2", "sF3", "sF4"
)
df <- df %>%
group_by(vowel) %>%
mutate(
across(all_of(acoustic_vars),
~ is_not_outlier_mad(.x),
.names = "keep_{col}")
) %>%
ungroup()
# ---------------------
# fit gamm
library(tidyverse)
library(mgcv)
library(itsadug)
options(contrasts = c("contr.sum", "contr.poly"))
# -------------------------------------------
# FIX NORMALIZED TIME
# -------------------------------------------
df <- df %>%
group_by(Filename) %>%
mutate(
normalized_time = (row_number() - 1) / (n() - 1)
) %>%
ungroup()
# -------------------------------------------
# PREP DATA
# -------------------------------------------
df_gamm <- df %>%
filter(
!is.na(vowel),
!is.na(sF1), !is.na(sF2),
!is.na(gender),
!is.na(ground_truth_label)
) %>%
mutate(
vowel              = factor(vowel),
speaker            = factor(speaker),
gender             = factor(gender, levels = c("female","male")),
ground_truth_label = factor(ground_truth_label),
prec_sound         = factor(prec_sound),
foll_sound         = factor(foll_sound)
)
vowels <- levels(df_gamm$vowel)
models_F1 <- list()
models_F2 <- list()
# -------------------------------------------
# GAMM LOOP
# -------------------------------------------
for (v in vowels) {
cat("\n==============================\n")
cat("Now analyzing vowel:", v, "\n")
cat("==============================\n")
vowel_data <- df_gamm %>%
filter(vowel == v) %>%
droplevels()
# -------------------------------------------
# MODEL FORMULAS
# -------------------------------------------
form_F1 <- sF1 ~ ground_truth_label * gender +
s(normalized_time, by = ground_truth_label, k = 5) +
s(normalized_time, by = gender, k = 5) +
s(speaker, bs = "re") +
s(prec_sound, bs = "re") +
s(foll_sound, bs = "re")
form_F2 <- sF2 ~ ground_truth_label * gender +
s(normalized_time, by = ground_truth_label, k = 5) +
s(normalized_time, by = gender, k = 5) +
s(speaker, bs = "re") +
s(prec_sound, bs = "re") +
s(foll_sound, bs = "re")
# -------------------------------------------
# FIT MODELS
# -------------------------------------------
m1 <- bam(
form_F1,
data = vowel_data,
method = "fREML",
discrete = TRUE,
control = gam.control(trace = TRUE)
)
m2 <- bam(
form_F2,
data = vowel_data,
method = "fREML",
discrete = TRUE,
control = gam.control(trace = TRUE)
)
models_F1[[v]] <- m1
models_F2[[v]] <- m2
cat("\n--- Summary F1 /", v, "---\n")
print(summary(m1))
cat("\n--- Summary F2 /", v, "---\n")
print(summary(m2))
# -------------------------------------------
# PREDICTION GRID (safe)
# -------------------------------------------
new_data <- expand.grid(
normalized_time    = seq(0, 1, length.out = 40),
ground_truth_label = levels(vowel_data$ground_truth_label),
gender             = levels(vowel_data$gender)
) %>%
mutate(
speaker    = vowel_data$speaker[1],      # dummy for prediction
prec_sound = vowel_data$prec_sound[1],   # dummy
foll_sound = vowel_data$foll_sound[1]    # dummy
)
new_data$F1_pred <- predict(m1, new_data, exclude = "s(speaker)")
new_data$F2_pred <- predict(m2, new_data, exclude = "s(speaker)")
# -------------------------------------------
# PLOT TRAJECTORY
# -------------------------------------------
p <- ggplot(
new_data,
aes(
x = F2_pred,
y = F1_pred,
color = gender,
linetype = ground_truth_label,
group = interaction(ground_truth_label, gender)
)
) +
geom_path(
linewidth = 1,
arrow = arrow(angle = 20, length = unit(0.1, "inches"), type = "closed")
) +
scale_x_reverse("F2 (Hz)") +
scale_y_reverse("F1 (Hz)") +
theme_classic(base_size = 16) +
ggtitle(paste("F1–F2 Trajectory (Label × Gender) for vowel /", v, "/", sep = "")) +
theme(legend.position = "right")
print(p)
}
library(tidyverse)
library(mgcv)
library(itsadug)
# ---------------------
# Load ground truth csv
ground_truth <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/acoustic_data/formants/ground_truth_label.csv")
# ---------------------
# Load acoustic csv
df <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/acoustic_data/formants/output_all.csv") %>%
mutate(speaker = substr(Filename, 1, 3))
# ---------------------
# join and build df
df <- df %>%
left_join(ground_truth, by = "speaker") %>%
select(
Filename, Label, seg_Start, seg_End,
H1c, H2H4c, H42Kc, H2KH5Kc,
CPP, Energy,
HNR05, HNR15, HNR25, HNR35,
sF0, sF1, sF2, sF3, sF4,
epoch, soe,
speaker, ground_truth_label, mean_gender_scale
) %>%
filter(
if_all(
-c(soe, epoch),
~ .x != 0
)
) %>%
mutate(
modality = case_when(
str_ends(speaker, "hc") ~ "breathy_creaky",
str_ends(speaker, "c")  ~ "creaky",
str_ends(speaker, "h")  ~ "breathy",
TRUE ~ "modal"
)
) %>%
filter(str_detect(Filename, "central|mono|raising|fronting")) %>%
mutate(
sentence_type = case_when(
str_detect(Filename, "central")  ~ "central",
str_detect(Filename, "mono")     ~ "mono",
str_detect(Filename, "raising")  ~ "raising",
str_detect(Filename, "fronting") ~ "fronting",
TRUE ~ NA_character_
)
)
df <- df %>%
select(
Filename,
Label,
ground_truth_label,
mean_gender_scale,
modality,
sentence_type,
everything()
)
# ---------------------
# add vowel code
vowel_codes <- read_csv("/Users/noahkhaloo/Desktop/TTS_perception/data/metadata/vowel_codes.csv") %>%
rename(Label = "code") %>%
mutate(Label = as.character(Label))
# join
df <- df %>%
left_join(vowel_codes, by = "Label")
# ---------------------
# create ground truth gender column
df <- df %>%
mutate(
gender = substr(Filename, 2, 2),
gender = case_when(
gender == "F" ~ "female",
gender == "M" ~ "male",
TRUE ~ NA_character_
)
)
# ---------------------
# add normalized time
df <- df %>%
mutate(
seg_Start_sec = seg_Start / 1000,
seg_End_sec   = seg_End   / 1000
) %>%
group_by(Filename) %>%
mutate(
time_sec = seq(seg_Start_sec[1], seg_End_sec[1], length.out = n()),
normalized_time = (time_sec - seg_Start_sec[1]) /
(seg_End_sec[1] - seg_Start_sec[1])
) %>%
ungroup()
# ---------------------
# fix vowel names
df <- df %>%
mutate(
vowel = case_when(
vowel %in% c("ɑh","ah") ~ "ɑ",
vowel == "ih"           ~ "ɪ",
vowel == "ai"           ~ "æi",
vowel == "ɑ'"           ~ "æ",
TRUE ~ vowel
)
) %>%
drop_na(vowel)
# ---------------------
# filter out outliers
is_not_outlier_mad <- function(x, k = 3.5) {
med <- median(x, na.rm = TRUE)
mad_val <- mad(x, constant = 1, na.rm = TRUE)
abs(x - med) < k * mad_val
}
acoustic_vars <- c(
"H1c", "H2H4c", "H42Kc", "H2KH5Kc",
"CPP", "Energy",
"HNR05", "HNR15", "HNR25", "HNR35",
"sF0", "sF1", "sF2", "sF3", "sF4"
)
df <- df %>%
group_by(vowel) %>%
mutate(
across(all_of(acoustic_vars),
~ is_not_outlier_mad(.x),
.names = "keep_{col}")
) %>%
ungroup()
# ---------------------
# fit gamm
library(tidyverse)
library(mgcv)
library(itsadug)
options(contrasts = c("contr.sum", "contr.poly"))
# ------------------------
# Prep GAMM dataset
# ------------------------
df_gamm <- df %>%
filter(
!is.na(vowel),
!is.na(sF1), !is.na(sF2),
!is.na(gender),
!is.na(ground_truth_label)
) %>%
mutate(
speaker            = factor(speaker),
vowel              = factor(vowel),
gender             = factor(gender, levels = c("female", "male")),
ground_truth_label = factor(ground_truth_label),
label_gender       = interaction(ground_truth_label, gender, drop = TRUE),
prec_sound         = factor(prec_sound),
foll_sound         = factor(foll_sound)
)
vowels <- levels(df_gamm$vowel)
models_F1 <- list()
models_F2 <- list()
# ------------------------
# GAMM LOOP
# ------------------------
for (v in vowels) {
cat("\n\n==================================\n")
cat("Now analyzing vowel:", v, "\n")
cat("==================================\n\n")
vowel_data <- df_gamm %>% filter(vowel == v)
# ------------------------
# Build formulas
# ------------------------
form_F1 <- sF1 ~ ground_truth_label * gender +
s(normalized_time, by = ground_truth_label, k = 5) +
s(normalized_time, by = gender, k = 5) +
s(speaker, bs = "re") +
s(prec_sound, bs = "re") +
s(foll_sound, bs = "re")
form_F2 <- sF2 ~ ground_truth_label * gender +
s(normalized_time, by = ground_truth_label, k = 5) +
s(normalized_time, by = gender, k = 5) +
s(speaker, bs = "re") +
s(prec_sound, bs = "re") +
s(foll_sound, bs = "re")
# ------------------------
# Fit GAMMs
# ------------------------
model_F1 <- bam(
form_F1,
data = vowel_data,
method = "fREML",
select = TRUE
)
model_F2 <- bam(
form_F2,
data = vowel_data,
method = "fREML",
select = TRUE
)
models_F1[[v]] <- model_F1
models_F2[[v]] <- model_F2
cat("\n--- Summary F1 /", v, "---\n")
print(summary(model_F1))
cat("\n--- Summary F2 /", v, "---\n")
print(summary(model_F2))
# ------------------------
# Prediction grid
# ------------------------
new_data <- expand.grid(
normalized_time    = seq(0, 1, length.out = 40),
ground_truth_label = levels(vowel_data$ground_truth_label),
gender             = levels(vowel_data$gender)
) %>%
mutate(
label_gender = interaction(ground_truth_label, gender, drop = TRUE),
# supply valid levels for random effects (will be excluded anyway)
speaker      = vowel_data$speaker[1],
prec_sound   = vowel_data$prec_sound[1],
foll_sound   = vowel_data$foll_sound[1]
)
# ------------------------
# Exclude ALL random effects when predicting
# ------------------------
exclude_terms <- c(
"s(speaker)",
"s(prec_sound)",
"s(foll_sound)"
)
new_data <- new_data %>%
mutate(
F1_pred = predict(
model_F1,
newdata = .,
exclude = exclude_terms,
type = "response"
),
F2_pred = predict(
model_F2,
newdata = .,
exclude = exclude_terms,
type = "response"
)
)
# ------------------------
# Plot trajectory
# ------------------------
plot <- ggplot(
new_data,
aes(
x = F2_pred, y = F1_pred,
color = gender,
linetype = ground_truth_label,
group = interaction(ground_truth_label, gender)
)
) +
geom_path(
arrow = arrow(angle = 20, length = unit(0.1, "inches")),
linewidth = 1
) +
scale_x_reverse(name = "F2 (Hz)") +
scale_y_reverse(name = "F1 (Hz)") +
theme_classic() +
ggtitle(paste0("Formant trajectory (Label × Gender) for vowel /", v, "/"))
print(plot)
}
#male and female separate plots. produce plot and model structure.
#do it individually rather than all at once
#still predicting weird stuff for F2
