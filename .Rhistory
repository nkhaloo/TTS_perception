modality,
vowel,
Label,
seg_Start,
seg_End
),
names_from = chunk,
values_from = matches("_(mean|cov)$"),
names_glue = "{.value}_{chunk}"
)
# ------------------------
# xg boosted trees
df_chunked_norm <- df_chunked %>%
mutate(
y = ifelse(ground_truth_label == "Black", 1, 0)
)
feature_cols <- df_chunked_norm %>%
select(matches("_(mean|cov)_(beg|mid|end)$")) %>%
colnames()
# model function
fit_xgb_model <- function(df, features) {
X <- as.matrix(df[, features])
y <- df$y
dmat <- xgb.DMatrix(data = X, label = y)
set.seed(123)
cv <- xgb.cv(
data = dmat,
nrounds = 50,
nfold = 5,
early_stopping_rounds = 10,
objective = "binary:logistic",
eval_metric = "error",   # <-- classification error
max_depth = 3,
eta = 0.1,
subsample = 0.8,
colsample_bytree = 0.8,
verbose = 0
)
best_error <- min(cv$evaluation_log$test_error_mean)
list(
accuracy = 1 - best_error,
best_iteration = cv$best_iteration
)
}
# baseline model
results_model1 <- df_chunked_norm %>%
group_split(vowel) %>%
map_df(~ {
out <- fit_xgb_model(.x, feature_cols)
tibble(
vowel = unique(.x$vowel),
model = "raw",
accuracy = out$accuracy
)
})
center_by_modality <- function(df, features) {
df %>%
group_by(modality) %>%
mutate(
across(
all_of(features),
~ .x - mean(.x, na.rm = TRUE)
)
) %>%
ungroup()
}
# modality centered model
results_model2 <- df_chunked_norm %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, feature_cols)
out <- fit_xgb_model(df_centered, feature_cols)
tibble(
vowel = unique(.x$vowel),
model = "modality_centered",
accuracy = out$accuracy
)
})
# get results
results_all <- bind_rows(results_model1, results_model2)
comparison <- results_all %>%
pivot_wider(
names_from = model,
values_from = accuracy
) %>%
mutate(
delta = modality_centered - raw
)
comparison %>%
summarise(
mean_raw = mean(raw),
mean_centered = mean(modality_centered),
mean_delta = mean(delta)
)
# feature importance
get_feature_importance <- function(df, features) {
X <- as.matrix(df[, features])
y <- df$y
dmat <- xgb.DMatrix(data = X, label = y)
model <- xgboost(
data = dmat,
nrounds = 50,
objective = "binary:logistic",
max_depth = 3,
eta = 0.1,
subsample = 0.8,
colsample_bytree = 0.8,
verbose = 0
)
xgb.importance(
feature_names = features,
model = model
)
}
importance_by_vowel <- df_chunked_norm %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- .x %>%
group_by(modality) %>%
mutate(
across(
all_of(feature_cols),
~ .x - mean(.x, na.rm = TRUE)
)
) %>%
ungroup()
imp <- get_feature_importance(df_centered, feature_cols)
imp %>%
mutate(vowel = unique(.x$vowel))
})
# plot that shows all features
importance_all <- importance_by_vowel %>%
group_by(Feature) %>%
summarise(
mean_gain = mean(Gain),
.groups = "drop"
) %>%
arrange(mean_gain)
#save top 15 features for all gender model
top15_unnamed <- importance_all %>%
slice_max(mean_gain, n = 15) %>%
arrange(mean_gain)
#rename top 15 features for all-gender model
feature_labels <- c(
sF1_mean_mid   = "F1 mean (mid point)",
sF3_cov_beg    = "F3 CoV (vowel onset)",
DF_mean_beg    = "DF mean (vowel onset)",
sF1_mean_beg   = "F1 mean (vowel onset)",
H42Kc_cov_end  = "H4–2kHz CoV (vowel offset)",
H2KH5Kc_mean_beg = "H2k–5kHz mean (vowel onset)",
H1Res_cov_end  = "H1Res CoV (vowel offset)",
sF0_cov_mid    = "F0 CoV (mid vowel)",
CPP_cov_end    = "CPP CoV (vowel offset)",
sF1_cov_mid    = "F1 CoV (mid point)",
sF1_cov_end    = "F1 CoV (vowel offset)",
sF4_cov_mid    = "F4 CoV (mid point)",
CPP_mean_beg   = "CPP mean (vowel onset)",
sF2_mean_beg   = "F2 mean (vowel onset)",
H42Kc_cov_beg  = "H4–2kHz CoV (vowel onset)"
)
#save top 15 renamed features in a new df
top15 <- top15_unnamed %>%
mutate(
Feature_label = recode(Feature, !!!feature_labels)
)
ggplot(top15,
aes(x = mean_gain,
y = reorder(Feature_label, mean_gain))) +
geom_col(fill = "steelblue") +
labs(
x = "Mean Gain",
y = "Feature"
) +
theme_minimal()
# run xgboost on male only df
df_chunked_male <- df_chunked_norm %>%
filter(gender != "female")
results_model3 <- df_chunked_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, feature_cols)
out <- fit_xgb_model(df_centered, feature_cols)
tibble(
vowel = unique(.x$vowel),
model = "modality_centered_male_only",
accuracy = out$accuracy
)
})
results_all <- bind_rows(
results_model1,
results_model2,
results_model3
)
comparison <- results_all %>%
pivot_wider(
names_from = model,
values_from = accuracy
) %>%
mutate(
delta_centered_vs_raw = modality_centered - raw,
delta_male_vs_centered = modality_centered_male_only - modality_centered
)
comparison %>%
summarise(
mean_raw = mean(raw, na.rm = TRUE),
mean_centered = mean(modality_centered, na.rm = TRUE),
mean_male_only = mean(modality_centered_male_only, na.rm = TRUE),
mean_delta_centered = mean(delta_centered_vs_raw, na.rm = TRUE),
mean_delta_male = mean(delta_male_vs_centered, na.rm = TRUE)
)
importance_by_vowel_male <- df_chunked_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- .x %>%
group_by(modality) %>%
mutate(
across(
all_of(feature_cols),
~ .x - mean(.x, na.rm = TRUE)
)
) %>%
ungroup()
imp <- get_feature_importance(df_centered, feature_cols)
imp %>%
mutate(vowel = unique(.x$vowel))
})
importance_male_all <- importance_by_vowel_male %>%
group_by(Feature) %>%
summarise(
mean_gain = mean(Gain),
.groups = "drop"
) %>%
arrange(desc(mean_gain))
top15_male <- importance_male_all %>%
slice_max(mean_gain, n = 15) %>%
arrange(mean_gain)
# rename male features
top15_male_labeled <- top15_male %>%
mutate(
Feature_label = recode(
Feature,
CPP_cov_beg        = "CPP CoV (vowel onset)",
CPP_cov_end        = "CPP CoV (vowel offset)",
SHR_mean_mid       = "SHR mean (mid point)",
sF3_mean_beg       = "F3 mean (vowel onset)",
sF3_cov_beg        = "F3 CoV (vowel onset)",
sF3_cov_mid        = "F3 CoV (mid point)",
sF1_cov_end        = "F1 CoV (vowel offset)",
sF2_mean_end       = "F2 mean (vowel offset)",
DF_cov_beg         = "DF CoV (vowel onset)",
H1Res_mean_end     = "H1Res mean (vowel offset)",
H1Res_cov_mid      = "H1Res CoV (mid point)",
H2H4c_mean_mid     = "H2–H4 mean (mid point)",
H2KH5Kc_cov_beg    = "H2k–5kHz CoV (vowel onset)",
H2KH5Kc_mean_mid   = "H2k–5kHz mean (mid point)",
H42Kc_cov_end      = "H4–2kHz CoV (vowel offset)"
)
)
# freeze top-15 feature sets
top15_all <- importance_all %>%
slice_max(mean_gain, n = 15) %>%
arrange(mean_gain)
# plot features from male model
ggplot(
top15_male_labeled,
aes(
x = mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(fill = "steelblue") +
labs(
x = "Mean Gain",
y = "Feature"
) +
theme_minimal()
# analyze feature overlap
normalize_feature_for_overlap <- function(feature) {
parts <- str_split(feature, "_", simplify = TRUE)
acoustic_var <- parts[, 1]
stat         <- parts[, 2]
chunk        <- parts[, 3]
case_when(
# mean: ignore chunk
stat == "mean" ~ paste(acoustic_var, stat, sep = "_"),
# cov: keep chunk
stat == "cov"  ~ paste(acoustic_var, stat, chunk, sep = "_"),
TRUE ~ feature
)
}
top15_all_cmp <- top15_all %>%
mutate(feature_cmp = normalize_feature_for_overlap(Feature))
top15_male_cmp <- top15_male %>%
mutate(feature_cmp = normalize_feature_for_overlap(Feature))
overlap_features_cmp <- intersect(
top15_all_cmp$feature_cmp,
top15_male_cmp$feature_cmp
)
overlap_features_cmp
length(overlap_features_cmp)
# look at formants
df_vowel_means <- df_chunked_norm %>%
mutate(
F2_mean_vowel = rowMeans(
select(., sF2_mean_beg, sF2_mean_mid, sF2_mean_end),
na.rm = TRUE
),
F3_mean_vowel = rowMeans(
select(., sF3_mean_beg, sF3_mean_mid, sF3_mean_end),
na.rm = TRUE
)
)
df_plot <- df_vowel_means %>%
group_by(vowel, ground_truth_label) %>%
summarise(
F2_mean = mean(F2_mean_vowel, na.rm = TRUE),
F3_mean = mean(F3_mean_vowel, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
`Listener-Assigned race` = ground_truth_label
)
ggplot(
df_plot,
aes(
x = vowel,
y = F2_mean,
fill = `Listener-Assigned race`
)
) +
geom_col(position = "dodge") +
labs(
x = "Vowel",
y = "Mean normalized F2",
fill = "Listener-Assigned race"
) +
theme_minimal()
ggplot(
df_plot,
aes(
x = vowel,
y = F3_mean,
fill = `Listener-Assigned race`
)
) +
geom_col(position = "dodge") +
labs(
x = "Vowel",
y = "Mean normalized F3",
fill = "Listener-Assigned race"
) +
theme_minimal()
# validate model results
# define 5 features to validate
features_to_validate <- c(
"H42Kc_cov_end",      # H4–2kHz CoV (vowel offset)
"sF3_cov_mid",        # F3 CoV (mid vowel)
"H1Res_cov_mid",      # H1Res CoV (mid vowel)
"H2KH5Kc_mean_mid",   # H2k–5kHz mean (mid vowel)
"sF3_cov_beg"         # F3 CoV (vowel onset)
)
# cohen's d
cohens_d <- function(x, group) {
x1 <- x[group == "Black"]
x2 <- x[group == "White"]
m1 <- mean(x1, na.rm = TRUE)
m2 <- mean(x2, na.rm = TRUE)
s1 <- sd(x1, na.rm = TRUE)
s2 <- sd(x2, na.rm = TRUE)
sp <- sqrt(((length(x1)-1)*s1^2 + (length(x2)-1)*s2^2) /
(length(x1) + length(x2) - 2))
(m1 - m2) / sp
}
d_results <- map_df(
features_to_validate,
function(feat) {
df_chunked_male %>%
group_by(vowel) %>%
summarise(
d = cohens_d(.data[[feat]], ground_truth_label),
feature = feat,
.groups = "drop"
)
}
)
d_results
# logistic regression
fit_glm_z <- glm(
y ~ vowel +
scale(H42Kc_cov_end) +
scale(sF3_cov_mid) +
scale(H1Res_cov_mid) +
scale(H2KH5Kc_mean_mid) +
scale(sF3_cov_beg),
data = df_chunked_male,
family = binomial
)
summary(fit_glm_z)
# All-gender model plot
top15_all <- top15_all %>%
mutate(
Feature_label = recode(
Feature,
sF1_mean_mid        = "F1 mean (mid point)",
sF3_cov_beg         = "F3 CoV (vowel onset)",
DF_mean_beg         = "DF mean (vowel onset)",
sF1_mean_beg        = "F1 mean (vowel onset)",
H42Kc_cov_end       = "H4–2kHz CoV (vowel offset)",
H2KH5Kc_mean_beg    = "H2k–5kHz mean (vowel onset)",
H1Res_cov_end       = "H1Res CoV (vowel offset)",
sF0_cov_mid         = "F0 CoV (mid vowel)",
CPP_cov_end         = "CPP CoV (vowel offset)",
sF1_cov_mid         = "F1 CoV (mid point)",
sF1_cov_end         = "F1 CoV (vowel offset)",
sF4_cov_mid         = "F4 CoV (mid point)",
CPP_mean_beg        = "CPP mean (vowel onset)",
sF2_mean_beg        = "F2 mean (vowel onset)",
H42Kc_cov_beg       = "H4–2kHz CoV (vowel onset)"
)
)
# overlapping raw feature names
overlap_features <- c(
"sF3_cov_beg",
"H2KH5Kc_mean_mid",
"H42Kc_cov_end"
)
# ----------------------------
# All-gender model plot
# ----------------------------
p_all <- ggplot(
top15_all,
aes(
x = mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(
aes(alpha = Feature %in% overlap_features),
fill = "steelblue"
) +
scale_alpha_manual(
values = c("TRUE" = 1, "FALSE" = 0.35),
guide = "none"
) +
scale_y_discrete(
position = "right",
labels = function(x) {
ifelse(
x %in% c(
"F3 CoV (vowel onset)",
"H4–2kHz CoV (vowel offset)",
"H2k–5kHz mean (mid point)"
),
paste0("**", x, "**"),
x
)
}
) +
labs(
title = "All-gender model",
x = "Mean Gain",
y = NULL
) +
theme_minimal() +
theme(
axis.text.y = element_markdown()
)
# ----------------------------
# Male-only model plot (mirrored)
# ----------------------------
p_male <- ggplot(
top15_male_labeled,
aes(
x = -mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(
aes(alpha = Feature %in% overlap_features),
fill = "steelblue"
) +
scale_alpha_manual(
values = c("TRUE" = 1, "FALSE" = 0.35),
guide = "none"
) +
scale_x_continuous(labels = abs) +
scale_y_discrete(
labels = function(x) {
ifelse(
x %in% c(
"F3 CoV (vowel onset)",
"H4–2kHz CoV (vowel offset)",
"H2k–5kHz mean (mid point)"
),
paste0("**", x, "**"),
x
)
}
) +
labs(
title = "Male-only model",
x = "Mean Gain",
y = NULL
) +
theme_minimal() +
theme(
axis.text.y = element_markdown()
)
# ----------------------------
# Combine plots
# ----------------------------
p_all | p_male
