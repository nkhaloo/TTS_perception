top15_all <- importance_all %>%
slice_max(mean_gain, n = 15) %>%
arrange(mean_gain)
# plot features from male model
ggplot(
top15_male_labeled,
aes(
x = mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(fill = "steelblue") +
labs(
x = "Mean Gain",
y = "Feature"
) +
theme_minimal()
# analyze feature overlap
normalize_feature_for_overlap <- function(feature) {
parts <- str_split(feature, "_", simplify = TRUE)
acoustic_var <- parts[, 1]
stat         <- parts[, 2]
chunk        <- parts[, 3]
case_when(
# mean: ignore chunk
stat == "mean" ~ paste(acoustic_var, stat, sep = "_"),
# cov: keep chunk
stat == "cov"  ~ paste(acoustic_var, stat, chunk, sep = "_"),
TRUE ~ feature
)
}
top15_all_cmp <- top15_all %>%
mutate(feature_cmp = normalize_feature_for_overlap(Feature))
top15_male_cmp <- top15_male %>%
mutate(feature_cmp = normalize_feature_for_overlap(Feature))
overlap_features_cmp <- intersect(
top15_all_cmp$feature_cmp,
top15_male_cmp$feature_cmp
)
overlap_features_cmp
length(overlap_features_cmp)
# look at formants
df_vowel_means <- df_chunked_norm %>%
mutate(
F2_mean_vowel = rowMeans(
select(., sF2_mean_beg, sF2_mean_mid, sF2_mean_end),
na.rm = TRUE
),
F3_mean_vowel = rowMeans(
select(., sF3_mean_beg, sF3_mean_mid, sF3_mean_end),
na.rm = TRUE
)
)
df_plot <- df_vowel_means %>%
group_by(vowel, ground_truth_label) %>%
summarise(
F2_mean = mean(F2_mean_vowel, na.rm = TRUE),
F3_mean = mean(F3_mean_vowel, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
`Listener-Assigned race` = ground_truth_label
)
ggplot(
df_plot,
aes(
x = vowel,
y = F2_mean,
fill = `Listener-Assigned race`
)
) +
geom_col(position = "dodge") +
labs(
x = "Vowel",
y = "Mean normalized F2",
fill = "Listener-Assigned race"
) +
theme_minimal()
ggplot(
df_plot,
aes(
x = vowel,
y = F3_mean,
fill = `Listener-Assigned race`
)
) +
geom_col(position = "dodge") +
labs(
x = "Vowel",
y = "Mean normalized F3",
fill = "Listener-Assigned race"
) +
theme_minimal()
# validate model results
# define 5 features to validate
features_to_validate <- c(
"H42Kc_cov_end",      # H4–2kHz CoV (vowel offset)
"sF3_cov_mid",        # F3 CoV (mid vowel)
"H1Res_cov_mid",      # H1Res CoV (mid vowel)
"H2KH5Kc_mean_mid",   # H2k–5kHz mean (mid vowel)
"sF3_cov_beg"         # F3 CoV (vowel onset)
)
# cohen's d
cohens_d <- function(x, group) {
x1 <- x[group == "Black"]
x2 <- x[group == "White"]
m1 <- mean(x1, na.rm = TRUE)
m2 <- mean(x2, na.rm = TRUE)
s1 <- sd(x1, na.rm = TRUE)
s2 <- sd(x2, na.rm = TRUE)
sp <- sqrt(((length(x1)-1)*s1^2 + (length(x2)-1)*s2^2) /
(length(x1) + length(x2) - 2))
(m1 - m2) / sp
}
d_results <- map_df(
features_to_validate,
function(feat) {
df_chunked_male %>%
group_by(vowel) %>%
summarise(
d = cohens_d(.data[[feat]], ground_truth_label),
feature = feat,
.groups = "drop"
)
}
)
d_results
# logistic regression
fit_glm_z <- glm(
y ~ vowel +
scale(H42Kc_cov_end) +
scale(sF3_cov_mid) +
scale(H1Res_cov_mid) +
scale(H2KH5Kc_mean_mid) +
scale(sF3_cov_beg),
data = df_chunked_male,
family = binomial
)
summary(fit_glm_z)
# All-gender model plot
top15_all <- top15_all %>%
mutate(
Feature_label = recode(
Feature,
sF1_mean_mid        = "F1 mean (mid point)",
sF3_cov_beg         = "F3 CoV (vowel onset)",
DF_mean_beg         = "DF mean (vowel onset)",
sF1_mean_beg        = "F1 mean (vowel onset)",
H42Kc_cov_end       = "H4–2kHz CoV (vowel offset)",
H2KH5Kc_mean_beg    = "H2k–5kHz mean (vowel onset)",
H1Res_cov_end       = "H1Res CoV (vowel offset)",
sF0_cov_mid         = "F0 CoV (mid vowel)",
CPP_cov_end         = "CPP CoV (vowel offset)",
sF1_cov_mid         = "F1 CoV (mid point)",
sF1_cov_end         = "F1 CoV (vowel offset)",
sF4_cov_mid         = "F4 CoV (mid point)",
CPP_mean_beg        = "CPP mean (vowel onset)",
sF2_mean_beg        = "F2 mean (vowel onset)",
H42Kc_cov_beg       = "H4–2kHz CoV (vowel onset)"
)
)
# overlapping raw feature names
overlap_features <- c(
"sF3_cov_beg",
"H2KH5Kc_mean_mid",
"H42Kc_cov_end"
)
# All-gender model plot
p_all <- ggplot(
top15_all,
aes(
x = mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(
aes(alpha = Feature %in% overlap_features),
fill = "steelblue"
) +
scale_alpha_manual(
values = c("TRUE" = 1, "FALSE" = 0.35),
guide = "none"
) +
scale_y_discrete(
position = "right",
labels = function(x) {
ifelse(
x %in% c(
"F3 CoV (vowel onset)",
"H4–2kHz CoV (vowel offset)",
"H2k–5kHz mean (mid point)"
),
paste0("**", x, "**"),
x
)
}
) +
labs(
title = "All-gender model",
x = "Mean Gain",
y = NULL
) +
theme_minimal() +
theme(
axis.text.y = element_markdown()
)
# ----------------------------
# Male-only model plot (mirrored)
# ----------------------------
p_male <- ggplot(
top15_male_labeled,
aes(
x = -mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(
aes(alpha = Feature %in% overlap_features),
fill = "steelblue"
) +
scale_alpha_manual(
values = c("TRUE" = 1, "FALSE" = 0.35),
guide = "none"
) +
scale_x_continuous(labels = abs) +
scale_y_discrete(
labels = function(x) {
ifelse(
x %in% c(
"F3 CoV (vowel onset)",
"H4–2kHz CoV (vowel offset)",
"H2k–5kHz mean (mid point)"
),
paste0("**", x, "**"),
x
)
}
) +
labs(
title = "Male-only model",
x = "Mean Gain",
y = NULL
) +
theme_minimal() +
theme(
axis.text.y = element_markdown()
)
# Combine plots
p_all | p_male
# regression using top five features
df_chunked_male <- df_chunked_male %>%
mutate(
race_bin = ifelse(ground_truth_label == "Black", 1, 0)
)
fit_glm_male <- glm(
race_bin ~
scale(H1Res_cov_mid) +
scale(sF3_cov_beg) +
scale(sF3_cov_mid) +
scale(H2KH5Kc_mean_mid) +
scale(H42Kc_cov_end),
data = df_chunked_male,
family = binomial
)
summary(fit_glm_male)
# assess variability
df_chunked_male <- df_chunked_male %>%
mutate(
cov_global = rowMeans(
select(., matches("_cov_")),
na.rm = TRUE
)
) %>%
filter(is.finite(cov_global))
df_plot_global <- df_chunked_male %>%
group_by(ground_truth_label) %>%
summarise(
mean_value = mean(cov_global, na.rm = TRUE),
se = sd(cov_global, na.rm = TRUE) / sqrt(n()),
.groups = "drop"
)
ggplot(
df_plot_global,
aes(
x = ground_truth_label,
y = mean_value,
fill = ground_truth_label
)
) +
geom_col(width = 0.6) +
geom_errorbar(
aes(
ymin = mean_value - se,
ymax = mean_value + se
),
width = 0.2
) +
theme_minimal() +
labs(
x = "Listener-assigned race",
y = "Mean global CoV"
)
mod_cov_global <- lmer(
cov_global ~ ground_truth_label + (1 | speaker),
data = df_chunked_male
)
summary(mod_cov_global)
# plot individual variation variables
top3_cov_features <- c(
"H1Res_cov_mid",
"sF3_cov_mid",
"H42Kc_cov_end"
)
df_plot <- df_chunked_male %>%
select(ground_truth_label, all_of(top3_cov_features)) %>%
pivot_longer(
cols = all_of(top3_cov_features),
names_to = "feature",
values_to = "value"
) %>%
group_by(ground_truth_label, feature) %>%
summarise(
mean_value = mean(value, na.rm = TRUE),
se = sd(value, na.rm = TRUE) / sqrt(n()),
.groups = "drop"
)
ggplot(
df_plot,
aes(
x = ground_truth_label,
y = mean_value,
fill = ground_truth_label
)
) +
geom_col(width = 0.6) +
geom_errorbar(
aes(
ymin = mean_value - se,
ymax = mean_value + se
),
width = 0.2
) +
facet_wrap(~ feature, scales = "free_y") +
theme_minimal() +
labs(
x = "Listener-assigned race",
y = "Mean CoV"
)
mod_H1Res <- lmer(
H1Res_cov_mid ~ ground_truth_label + (1 | speaker),
data = df_chunked_male
)
mod_sF3 <- lmer(
sF3_cov_mid ~ ground_truth_label + (1 | speaker),
data = df_chunked_male
)
mod_H42Kc <- lmer(
H42Kc_cov_end ~ ground_truth_label + (1 | speaker),
data = df_chunked_male
)
summary(mod_H1Res)
summary(mod_sF3)
summary(mod_H42Kc)
# using vowel means only
# ============================================================
# TOKEN-LEVEL (NO CHUNKS), MEN-ONLY: mean + CoV across entire token
# ============================================================
# 1) Men-only frame data (consistent with your earlier male-only filter)
df_clean_male <- df_clean %>%
filter(gender != "female")
# 2) Summarise acoustics by vowel token (entire token, no beg/mid/end)
df_token_male <- df_clean_male %>%
group_by(
Filename,
speaker,
gender,
ground_truth_label,
vowel,
Label,
modality,
seg_Start,
seg_End
) %>%
summarise(
across(
all_of(analysis_vars),
list(
mean = mean,
cov  = ~ sd(.x) / mean(.x)
),
.names = "{col}_{fn}"
),
.groups = "drop"
)
# 3) Create binary outcome
df_token_male <- df_token_male %>%
mutate(
y = ifelse(ground_truth_label == "Black", 1, 0)
)
# 4) Feature columns: all *_mean and *_cov
token_feature_cols_male <- df_token_male %>%
select(matches("_(mean|cov)$")) %>%
colnames()
# 5) Fit token-level model per vowel (modality-centered, men-only)
results_token_male <- df_token_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, token_feature_cols_male)
out <- fit_xgb_model(df_centered, token_feature_cols_male)
tibble(
vowel = unique(.x$vowel),
model = "token_modality_centered_male_only",
accuracy = out$accuracy
)
})
# Optional: print mean accuracy across vowels
results_token_male %>%
summarise(mean_accuracy = mean(accuracy, na.rm = TRUE))
# ============================================================
# TOKEN-LEVEL FEATURE IMPORTANCE (MEN-ONLY, same plot style)
# ============================================================
importance_token_male_by_vowel <- df_token_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, token_feature_cols_male)
imp <- get_feature_importance(df_centered, token_feature_cols_male)
imp %>% mutate(vowel = unique(.x$vowel))
})
importance_token_male_all <- importance_token_male_by_vowel %>%
group_by(Feature) %>%
summarise(
mean_gain = mean(Gain),
.groups = "drop"
) %>%
arrange(desc(mean_gain))
top15_token_male <- importance_token_male_all %>%
slice_max(mean_gain, n = 15) %>%
arrange(mean_gain)
# Optional: simple readable labels without manual recode
pretty_feature_label_token <- function(f) {
parts <- str_split(f, "_", simplify = TRUE)
var  <- parts[, 1]
stat <- parts[, 2]
stat_lab <- ifelse(stat == "mean", "mean", "CoV")
paste0(var, " ", stat_lab, " (token)")
}
top15_token_male <- top15_token_male %>%
mutate(Feature_label = pretty_feature_label_token(Feature))
ggplot(
top15_token_male,
aes(
x = mean_gain,
y = reorder(Feature_label, mean_gain)
)
) +
geom_col(fill = "steelblue") +
labs(
title = "Token-level model (men-only, modality-centered): top features",
x = "Mean Gain",
y = "Feature"
) +
theme_minimal()
# ============================================================
# COMPARE PERFORMANCE: original chunked vs token-level mean/CoV
# (MEN-ONLY, modality-centered for both)
# ============================================================
# --- A) Original model (chunked) performance, men-only ---
# Uses: df_chunked_male (you already created), feature_cols (your chunk feature set)
results_original_male <- df_chunked_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, feature_cols)
out <- fit_xgb_model(df_centered, feature_cols)
tibble(
vowel = unique(.x$vowel),
model = "original_chunked_male",
accuracy = out$accuracy
)
})
# --- B) Mean/CoV token model performance, men-only ---
# Uses: df_token_male + token_feature_cols_male (from the token-level section)
results_token_male <- df_token_male %>%
group_split(vowel) %>%
map_df(~ {
df_centered <- center_by_modality(.x, token_feature_cols_male)
out <- fit_xgb_model(df_centered, token_feature_cols_male)
tibble(
vowel = unique(.x$vowel),
model = "token_mean_cov_male",
accuracy = out$accuracy
)
})
# --- C) Combine + compare ---
results_compare_models <- bind_rows(results_original_male, results_token_male)
comparison_models <- results_compare_models %>%
pivot_wider(
names_from = model,
values_from = accuracy
) %>%
mutate(
delta_token_minus_original = token_mean_cov_male - original_chunked_male
) %>%
arrange(delta_token_minus_original)
# Per-vowel comparison table
comparison_models
# Overall summary
comparison_models %>%
summarise(
mean_original = mean(original_chunked_male, na.rm = TRUE),
mean_token    = mean(token_mean_cov_male, na.rm = TRUE),
mean_delta    = mean(delta_token_minus_original, na.rm = TRUE)
)
